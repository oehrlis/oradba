# Release Notes - OraDBA v0.14.0

**Release Date:** January 5, 2026  
**Release Type:** Critical Bug Fix + Feature Release  
**Focus:** RMAN Wrapper Critical Bug Fix + Extension Checksums

## üî¥ CRITICAL UPDATE

**All users running automated RMAN backups should upgrade immediately.**

Version 0.14.0 fixes a **production-critical bug** in `oradba_rman.sh` where backup
failures were reported as successful, potentially leading to undetected backup failures.

### The Bug

**Problem:** RMAN always returns exit code 0, even on errors. The RMAN wrapper used
`tee` to capture output, which masked the RMAN exit code, causing all backups to be
reported as successful regardless of actual outcome.

**Evidence:**

```text
# Script incorrectly reported:
[INFO] RMAN execution successful for FREE
[INFO] Successful: 1, Failed: 0

# But log file showed:
RMAN-00569: =============== ERROR MESSAGE STACK FOLLOWS ===============
RMAN-00558: error encountered while parsing input commands
```

**Impact:** Production backup failures going undetected, compromising disaster
recovery capabilities.

### The Fix

**Solution:** Multi-layer error detection

1. **Capture RMAN exit code** before pipe masks it: `${PIPESTATUS[0]}`
2. **Pattern matching** for RMAN-00569 error in log file
3. **Fail if either** exit code non-zero OR error pattern found
4. **Always save** processed .rcv script for troubleshooting

**Result:** Reliable error detection and comprehensive failure reporting.

## Overview

Version 0.14.0 is a critical bug fix release that also introduces 5 new RMAN
features and extension checksum verification. The RMAN wrapper now provides
production-grade error detection, configurable backup paths, enhanced debugging
capabilities, and comprehensive troubleshooting support.

## What's New

### üêõ Critical Bug Fixes

#### RMAN False Success Reporting (Issue #56 Phase 6)

**Problem:** `oradba_rman.sh` reported success when RMAN backups failed

**Root Cause:**

- RMAN returns exit code 0 even on errors (Oracle RMAN behavior)
- Piping to `tee` for logging masked the RMAN exit code
- No error pattern detection in output

**Solution Implemented:**

```bash
# Execute RMAN and capture output
"${rman_cmd}" ${rman_args} @"${processed_script}" log="${sid_log}" 2>&1 | tee -a "${SCRIPT_LOG}"
local rman_exit_code=${PIPESTATUS[0]}  # Capture before pipe masks it

# Always save processed script
local saved_rcv="${log_dir}/${script_basename}_${TIMESTAMP}.rcv"
cp "${processed_script}" "${saved_rcv}"

# Check for RMAN errors in log file
if grep -q "RMAN-00569" "${sid_log}"; then
    oradba_log ERROR "RMAN execution failed: RMAN-00569 error detected"
    return 1
elif [[ ${rman_exit_code} -ne 0 ]]; then
    oradba_log ERROR "RMAN execution failed: exit code ${rman_exit_code}"
    return 1
else
    oradba_log INFO "RMAN execution successful"
    return 0
fi
```

**Testing:** 9 new BATS tests cover error detection, exit code handling, and log
pattern matching.

### ‚ú® New Features

#### 1. Backup Path Configuration

Configure backup destination paths per SID or override via CLI.

**Configuration File** (per-SID `oradba_rman.conf`):

```bash
# Set default backup path for this SID
export RMAN_BACKUP_PATH="/backup/prod"
```

**CLI Override:**

```bash
# Override configured path
oradba_rman.sh --sid PROD --rcv backup_full.rcv --backup-path /backup/prod_daily
```

**Template Usage:**

```rman
# Use <BACKUP_PATH> tag in RMAN scripts
BACKUP DATABASE FORMAT '<BACKUP_PATH>/%d_full_%U.bkp';
```

**Precedence:** CLI ‚Üí Config ‚Üí Empty (no substitution)

#### 2. Enhanced Dry-Run Mode

Comprehensive preview without executing RMAN.

```bash
oradba_rman.sh --sid FREE --rcv backup_full.rcv --dry-run
```

**Features:**

- **Saves** processed .rcv script to log directory with timestamp
- **Displays** complete generated RMAN script content
- **Shows** exact RMAN command that would be executed
- **Perfect** for debugging template processing and variable substitution

**Example Output:**

```text
[INFO] Dry-run mode: saving processed script to:
       /u01/admin/FREE/log/backup_full_20260105_143022.rcv

[INFO] Processed RMAN script content:
===============================================================================
ALLOCATE CHANNEL c1 TYPE DISK;
ALLOCATE CHANNEL c2 TYPE DISK;
BACKUP DATABASE FORMAT '/backup/prod/%d_full_%U.bkp' TAG 'FULL_BACKUP';
RELEASE CHANNEL c1;
RELEASE CHANNEL c2;
===============================================================================

[INFO] Would execute: rman target / @/tmp/oradba_rman_1234.rcv
[INFO] Dry-run complete - no RMAN commands executed
```

#### 3. Automatic Script Preservation

Every execution automatically saves the processed RMAN script.

**Behavior:**

- **Always saves** processed .rcv to log directory
- **Naming pattern:** `<script>_YYYYMMDD_HHMMSS.rcv` (matches log files)
- **Location:** Same as RMAN log file (`$ORADBA_ORA_ADMIN_SID/log`)
- **Retention:** Matches log file retention policy

**Example:**

```bash
$ oradba_rman.sh --sid FREE --rcv backup_full.rcv

# Creates:
/u01/admin/FREE/log/backup_full_20260105_143022.log  # RMAN log
/u01/admin/FREE/log/backup_full_20260105_143022.rcv  # Processed script
```

**Benefits:**

- Post-execution troubleshooting
- Audit trail of executed commands
- Template variable verification
- Backup restoration reference

#### 4. Cleanup Control

Preserve temp files for debugging parallel execution.

```bash
oradba_rman.sh --sid FREE --rcv backup_full.rcv --no-cleanup
```

**Features:**

- **Default:** Temp directory cleaned up after execution
- **With --no-cleanup:** Preserves `/tmp/oradba_rman_*/` directory
- **Shows** temp directory path in output
- **Useful** for debugging parallel execution issues

**Example Output:**

```text
[INFO] Temp directory preserved: /tmp/oradba_rman_12345
[INFO] Contains: processed scripts, job files, parallel execution logs
```

#### 5. Extension Checksum Verification

Verify integrity of custom OraDBA extensions.

**Feature:** New `check_extension_checksums()` function in `oradba_version.sh`

**Usage:**

```bash
# Create checksum file for extension
cd $ORADBA_PREFIX/extensions/customer
find . -type f ! -name '.*.checksum' -exec sha256sum {} \; > .customer.checksum

# Verify integrity
oradba_version.sh --verify
oradba_version.sh --info  # Also shows extension status
```

**Behavior:**

- **Auto-discovers** `.{extension}.checksum` files in `extensions/` directory
- **Verifies** each file listed in checksum against current state
- **Reports** status with color-coded output:
  - [OK] Extension verified (n files)
  - [X] Extension FAILED with list of modified/missing files
- **Integrates** with core integrity checks

**Example Output:**

```text
Extension Integrity Checks:
  [OK] customer extension verified (15 files)
  [OK] monitoring extension verified (8 files)
  [X] testing extension FAILED
    Modified: scripts/test_db.sh
    Missing: config/test.conf
```

### üìä Information Display Enhancements (Issue #56 Phase 6)

#### Configuration Viewer (`cfg` alias)

New alias using `show_config()` function to display OraDBA configuration hierarchy.

```bash
$ cfg  # or: show_config

OraDBA Configuration Hierarchy:
================================
1. Core Configuration:
   [[OK] loaded] /opt/oracle/local/oradba/etc/oradba_core.conf

2. Standard Configuration:
   [[OK] loaded] /opt/oracle/local/oradba/etc/oradba_standard.conf

3. Customer Configuration:
   [- not configured] /opt/oracle/local/oradba/etc/oradba_customer.conf

4. Default SID Configuration:
   [[OK] loaded] /opt/oracle/local/oradba/etc/sid._DEFAULT_.conf

5. SID-Specific Configuration (FREE):
   [[OK] loaded] /opt/oracle/local/oradba/etc/sid.FREE.conf
```

**Features:**

- Shows 5-level configuration hierarchy
- Validates which config files exist and were loaded
- Status indicators:
  - `[[OK] loaded]` - File exists and was sourced
  - `[[X] MISSING - REQUIRED]` - Required file not found
  - `[- not configured]` - Optional file not present
- Helps troubleshoot configuration precedence

#### PATH Viewer (`pth` alias)

Similar to `sqa` (SQLPATH viewer), displays PATH structure.

```bash
$ pth  # or: show_path

Current PATH:
=============
1. /opt/oracle/local/oradba/bin
2. /u01/app/oracle/product/19c/dbhome_1/bin
3. /usr/local/bin
4. /usr/bin
5. /bin
```

### üîç Standalone Prerequisites Checker (Issue #56 Phase 6)

`oradba_check.sh` now available as standalone release artifact.

**Download and Run Before Installation:**

```bash
# Download
curl -L -o oradba_check.sh \
  https://github.com/oehrlis/oradba/releases/download/v0.14.0/oradba_check.sh
chmod +x oradba_check.sh

# Run
./oradba_check.sh

# Verbose output
./oradba_check.sh --verbose
```

**Validates:**

- System tools: bash, tar, awk, sed, grep, find, sort, base64
- Checksum utilities: sha256sum or shasum

### Logging Infrastructure (Issue #16)

Core logging infrastructure with persistent file logging and per-session logs.

**New Functions:**

1. **`init_logging()`** - Initialize main log directory
   - Creates `/var/log/oradba` or falls back to `~/.oradba/logs`
   - Sets `ORADBA_LOG_DIR` and `ORADBA_LOG_FILE`
   - Idempotent (safe to call multiple times)

2. **`init_session_log()`** - Create per-session log
   - Unique filenames: `session_YYYYMMDD_HHMMSS_PID.log`
   - Metadata header with user, host, PID, Oracle environment
   - Dual logging support (main log + session log)
   - Optional session-only logging via `ORADBA_SESSION_LOG_ONLY=true`

3. **Enhanced `oradba_log()`** - Improved logging function
   - Optional caller information via `ORADBA_LOG_SHOW_CALLER=true`
   - Format: `[LEVEL] TIMESTAMP [file:line] - message`
   - Dual logging to both main and session logs
   - **Note**: Renamed from `log()` to `oradba_log()` to avoid conflicts with `log` alias

**Usage:**

```bash
# Initialize logging
init_logging
init_session_log

# Log messages
oradba_log INFO "Starting backup process"
oradba_log DEBUG "Processing database FREE"
oradba_log WARN "Low disk space detected"
oradba_log ERROR "Backup failed"

# Enable caller information
export ORADBA_LOG_SHOW_CALLER=true
oradba_log INFO "This shows file and line number"

# Session-only logging
export ORADBA_SESSION_LOG_ONLY=true
oradba_log INFO "Only logged to session file"
```

**Test Coverage:**

- 23 comprehensive BATS tests in `tests/test_logging_infrastructure.bats`
- Tests cover directory initialization, fallback behavior, session logs, caller info, dual logging

### üîÑ Function Rename: `log()` ‚Üí `oradba_log()` (Issue #16)

**Root Cause:** The `log` alias defined in `oradba_standard.conf` (`alias log='cd ${ORADBA_LOG}'`)
conflicted with the `log()` function. When bash parsed `log() {`, it expanded the alias first,
turning it into `cd ${ORADBA_LOG}() {` - a syntax error.

**Solution:** Renamed function to `oradba_log()` for cleaner namespace separation.

**Impact:**

- All internal calls updated across 9 files
- Documentation updated with new function name
- Deprecated wrapper functions remain for compatibility:
  - `log_info()` ‚Üí calls `oradba_log INFO`
  - `log_warn()` ‚Üí calls `oradba_log WARN`
  - `log_error()` ‚Üí calls `oradba_log ERROR`
  - `log_debug()` ‚Üí calls `oradba_log DEBUG`

**Migration:** Update your scripts to use `oradba_log` instead of `log`:

```bash
# Old (still works via deprecated wrappers)
log INFO "message"

# New (recommended)
oradba_log INFO "message"
```

### üêõ SID Config Auto-Creation Fixed (Issue #16)

Fixed regression from v0.13.5 where SID-specific config files were not being auto-created.

**Bugs Fixed:**

1. **Wrong variable name** in `oradba_standard.conf`:
   - Was: `generate_sid_lists "${ORATAB:-/etc/oratab}"`
   - Now: `generate_sid_lists "${ORATAB_FILE}"`
   - Result: `ORADBA_REALSIDLIST` now populated correctly

2. **Wrong regex pattern** in `oradba_common.sh`:
   - Was: `[[ " ${ORADBA_REALSIDLIST} " =~  ${sid}  ]]`
   - Now: `[[ " ${ORADBA_REALSIDLIST} " =~ " ${sid} " ]]`
   - Result: Pattern now matches SIDs correctly

3. **Logic error** after v0.13.5 refactoring:
   - Was: `if ! load_config_file "${sid_config}"; then`
   - Now: `if [[ -f "${sid_config}" ]]; then`
   - Result: Auto-creation block now triggers when file missing

**Behavior:** When you first source an environment for a SID that doesn't have a config file:

```bash
$ . oraenv.sh FREE

[INFO] Auto-creating SID configuration for FREE...
[INFO] ‚úì Created SID configuration: /opt/oracle/local/oradba/etc/sid.FREE.conf
```

**Validates:**

- Disk space: 100MB minimum
- Oracle environment (if configured)
- Optional tools: rlwrap, curl/wget

**Build System:**

- `scripts/build_installer.sh` creates 3 release artifacts:
  - `oradba-X.Y.Z.tar.gz` (full package)
  - `oradba_install.sh` (installer with embedded payload)
  - `oradba_check.sh` (standalone prerequisites checker)

## Changed Files

### Core Scripts

**`src/bin/oradba_rman.sh`** (v0.13.7 ‚Üí v0.14.0)

- **Lines changed:** +76 insertions, -10 deletions
- **New variables:** `OPT_BACKUP_PATH`, `OPT_NO_CLEANUP`
- **Enhanced functions:**
  - `load_rman_config()` - Load RMAN_BACKUP_PATH from config
  - `process_template()` - Support `<BACKUP_PATH>` tag
  - `execute_rman_for_sid()` - **Critical error detection fix**
  - `usage()` - Document new parameters
- **Error detection:**
  - Capture `${PIPESTATUS[0]}` before pipe masks exit code
  - Check log for RMAN-00569 error pattern
  - Always save processed script for troubleshooting
- **New parameters:**
  - `--backup-path <path>` - Override backup destination
  - `--no-cleanup` - Preserve temp directory

**`src/bin/oradba_version.sh`** (v0.11.0 ‚Üí v0.14.0)

- **Lines changed:** +86 insertions
- **New function:** `check_extension_checksums()`
  - Auto-discovers `.{extension}.checksum` files
  - Verifies each extension's file integrity
  - Reports status with color-coded output
  - Returns combined status of core + extension checks
- **Integration:** Called by `check_integrity()` and displayed in `--info`

**`src/bin/oradba_check.sh`** (v0.7.0 ‚Üí v0.13.7)

- Added base64 availability check (required for embedded payload installer)
- Enhanced documentation for standalone use
- Updated usage text with pre-installation examples

### Documentation

**`src/doc/02-installation.md`**

- **Restructured** installation methods with 6 comprehensive use cases:
  1. Quick install with embedded payload (recommended)
  2. Air-gapped install with embedded payload
  3. Air-gapped install with separate tarball
  4. Direct from GitHub repository
  5. Ansible automated deployment (with playbook example)
  6. Parallel installation with TVD BasEnv
- **Added** Installation Scenarios section:
  - New installation
  - Update existing installation
  - Version management (side-by-side)
  - Custom installation prefix
  - User and permissions
- **Improved** Ansible integration with complete playbook example
- **Enhanced** BasEnv coexistence documentation

**`src/doc/09-rman-scripts.md`**

- Updated features list with error detection
- Added `--backup-path` and `--no-cleanup` to usage
- Updated configuration example with `RMAN_BACKUP_PATH`
- Added `<BACKUP_PATH>` to template tags documentation
- Added comprehensive troubleshooting section
- Updated examples with new options

**`src/doc/06-aliases.md`**

- Added Information Display section with `cfg`, `pth`, `sqa` aliases
- Grouped similar aliases together
- Updated with consistent formatting

### Tests

**`tests/test_oradba_rman.bats`** (v0.13.0 ‚Üí v0.14.0)

- **Lines changed:** +78 insertions
- **New tests:** 9 comprehensive tests for v0.14.0 features
  1. `accepts --backup-path option`
  2. `accepts --no-cleanup flag`
  3. `enhanced dry-run displays script content`
  4. `enhanced dry-run saves processed script`
  5. `loads RMAN_BACKUP_PATH from config`
  6. `CLI --backup-path overrides config`
  7. `--help shows new options`
  8. `template processing handles <BACKUP_PATH> tag`
  9. Additional error detection tests

## Upgrade Priority

**Priority: HIGH** - Critical bug fix for production environments

### Who Should Upgrade Immediately

- **All users** running automated RMAN backups
- **Production environments** relying on backup notifications
- **Any environment** where backup failures must be detected

### Upgrade Benefits

1. **Reliability:** Guaranteed detection of RMAN backup failures
2. **Troubleshooting:** Enhanced debugging with preserved scripts
3. **Flexibility:** Configurable backup paths per environment
4. **Verification:** Extension integrity checking
5. **Observability:** Improved configuration visibility

### Backward Compatibility

‚úÖ **100% backward compatible** - No breaking changes

- All existing configurations continue to work
- New features are opt-in (CLI flags or config variables)
- Default behavior unchanged (except improved error detection)

## Installation

### New Installation

```bash
# Download latest installer
curl -L -o oradba_install.sh \
  https://github.com/oehrlis/oradba/releases/download/v0.14.0/oradba_install.sh
chmod +x oradba_install.sh

# Install
./oradba_install.sh
```

### Update from Previous Version

```bash
# Download v0.14.0 installer
curl -L -o oradba_install.sh \
  https://github.com/oehrlis/oradba/releases/download/v0.14.0/oradba_install.sh
chmod +x oradba_install.sh

# Update existing installation
./oradba_install.sh --update --prefix /opt/oradba
```

### Verification

```bash
# Check version
oradba_version.sh --check

# Verify installation integrity (includes extensions)
oradba_version.sh --verify

# Test RMAN wrapper
oradba_rman.sh --help
```

## Migration Guide

### From 0.13.x

No configuration changes required - upgrade is transparent.

#### Optional: Enable New Features

1. **Configure backup paths** (per-SID config):

   ```bash
   # Edit per-SID config
   vi $ORADBA_PREFIX/etc/sid.PRODDB.conf
   
   # Add:
   export RMAN_BACKUP_PATH="/backup/proddb"
   ```

2. **Use new dry-run** for debugging:

   ```bash
   # Preview generated script
   oradba_rman.sh --sid PRODDB --rcv backup_full.rcv --dry-run
   ```

3. **Create extension checksums** (if using extensions):

   ```bash
   cd $ORADBA_PREFIX/extensions/myextension
   find . -type f ! -name '.*.checksum' -exec sha256sum {} \; > .myextension.checksum
   ```

### Testing the Fix

Verify RMAN error detection works:

```bash
# Create intentionally broken RMAN script
echo "INVALID RMAN COMMAND;" > /tmp/test_error.rcv

# Run - should report failure
oradba_rman.sh --sid FREE --rcv /tmp/test_error.rcv

# Expected output:
# [ERROR] RMAN execution failed: RMAN-00569 error detected
# [ERROR] Check log: /u01/admin/FREE/log/test_error_20260105_150000.log
```

## Known Issues

None identified in this release.

## Contributors

- Stefan Oehrli ([@oehrlis](https://github.com/oehrlis))

## Links

- **GitHub Release:** <https://github.com/oehrlis/oradba/releases/tag/v0.14.0>
- **Full Changelog:** <https://github.com/oehrlis/oradba/compare/v0.13.5...v0.14.0>
- **Issue Tracker:** <https://github.com/oehrlis/oradba/issues>
- **Documentation:** <https://oehrlis.github.io/oradba/>

## See Also

- [Installation Guide](../../src/doc/02-installation.md) - Complete installation instructions
- [RMAN Scripts](../../src/doc/09-rman-scripts.md) - RMAN wrapper documentation
- [Configuration](../../src/doc/05-configuration.md) - Configuration hierarchy
- [Previous Releases](consolidated-v0.10.0-v0.18.5.md) - Earlier releases
