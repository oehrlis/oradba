# OraDBA v1.2.1 Release Notes

**Release Date:** January 16, 2026  
**Release Type:** Patch Release  
**Status:** Ready for Production

## Overview

OraDBA v1.2.1 is a patch release addressing two critical bugs discovered in v1.2.0:

1. PATH accumulation when sourcing environment repeatedly
2. Incorrect ORACLE_HOME for DataSafe connector installations

Both issues were reported by users, reproduced, and verified fixed through comprehensive testing.

## Critical Bug Fixes

### PATH Deduplication (Issue #1)

**Problem:**

- PATH environment variable accumulated duplicate entries on each environment switch
- Example: JDK paths went from 1→2→3→4 copies when running `oradba --silent` repeatedly
- Caused by configuration files being sourced directly without deduplication

**Root Cause:**

- Config files sourced via `source` command in `load_config_file()`
- New duplicate-checking code in `oradba_env_config.sh` was bypassed
- `set -x` trace revealed actual execution flow

**Solution:**

- Added PATH deduplication directly in `load_config_file()` function (oradba_common.sh:1808-1838)
- Deduplicates PATH after sourcing if it changed
- Uses `oradba_dedupe_path()` if available, falls back to awk implementation
- Preserves PATH order while removing duplicates

**Impact:**

- High: Affects all users who source environment multiple times
- Manifests as increasingly long PATH with duplicate directories
- Can cause performance degradation and confusion

**Verification:**

```bash
# Before fix: PATH grows on each source
free --silent && pth | wc -l  # 15 entries
free --silent && pth | wc -l  # 18 entries (duplicates added)
free --silent && pth | wc -l  # 21 entries (more duplicates)

# After fix: PATH remains stable
free --silent && pth | wc -l  # 15 entries
free --silent && pth | wc -l  # 15 entries (no duplicates)
```

### DataSafe ORACLE_HOME Adjustment (Issue #2)

**Problem:**

- DataSafe connector installations have unique directory structure
- Parent directory added to `oradba_homes.conf`: `/opt/oracle/product/exacc-wob-vwg-test`
- ORACLE_HOME must point to subdirectory: `$PARENT/oracle_cman_home`
- PATH must use `$PARENT/oracle_cman_home/bin` (not `$PARENT/bin`)

**Root Cause:**

- OraDBA treated DataSafe like other products, using registered path as-is
- DataSafe detection existed but ORACLE_HOME not adjusted before export
- Multiple code paths required fixes

**Solution:**
Implemented DataSafe ORACLE_HOME adjustment in three code paths:

1. **oraenv.sh** (lines 470-479): For oratab entries
2. **set_oracle_home_environment()** (lines 1640-1668): For Oracle Homes from oradba_homes.conf
3. **oradba_env_builder.sh** (lines 343-365): For Phase 2 architecture

Each path now:

- Detects when product type is "datasafe"
- Checks for `oracle_cman_home` subdirectory
- Adjusts ORACLE_HOME to append `/oracle_cman_home`
- Sets additional variables:
  - `DATASAFE_HOME`: Points to oracle_cman_home
  - `DATASAFE_INSTALL_DIR`: Points to parent directory
  - `DATASAFE_CONFIG`: Points to oracle_cman_home/config

**Impact:**

- Critical: Affects all DataSafe connector users
- Without fix: cmctl and other DataSafe commands fail
- PATH points to non-existent directory

**Verification:**

```bash
dscontest --silent

# After fix:
ORACLE_HOME: /opt/oracle/product/exacc-wob-vwg-test/oracle_cman_home  ✓
DATASAFE_HOME: /opt/oracle/product/exacc-wob-vwg-test/oracle_cman_home  ✓
DATASAFE_INSTALL_DIR: /opt/oracle/product/exacc-wob-vwg-test  ✓
PATH: .../oracle_cman_home/bin  ✓
```

## Product Type Architecture

OraDBA supports multiple product types with different directory structures:

| Product Type | Subdirectory? | PATH Pattern           | Special Handling?          |
|--------------|---------------|------------------------|----------------------------|
| RDBMS        | No            | `$ORACLE_HOME/bin`     | No                         |
| CLIENT       | No            | `$ORACLE_HOME/bin`     | No                         |
| ICLIENT      | No            | `$ORACLE_HOME` (flat)  | No                         |
| GRID         | No            | `$ORACLE_HOME/bin`     | No                         |
| OUD          | No            | `$ORACLE_HOME/oud/bin` | No                         |
| WEBLOGIC     | No            | `$WL_HOME/server/bin`  | No                         |
| OMS          | No            | `$ORACLE_HOME/bin`     | No                         |
| EMAGENT      | No            | `$ORACLE_HOME/bin`     | No                         |
| **DATASAFE** | **Yes**       | `$ORACLE_HOME/bin`     | **Yes** (oracle_cman_home) |

**Note:** DataSafe is the only product type requiring subdirectory adjustment for now.

## Code Paths

OraDBA has three distinct environment setup code paths:

1. **Database SIDs** (oratab entries)
   - Code: `oraenv.sh` → direct oratab parsing
   - Used by: Database instances (FREE, PROD, DEV)

2. **Oracle Homes** (oradba_homes.conf)
   - Code: `oraenv.sh` → `set_oracle_home_environment()`
   - Used by: DataSafe, Instant Client, OUD, WebLogic, etc.

3. **Phase 2 Architecture** (future)
   - Code: `oradba_env_builder.sh`
   - Used by: New environment builder (not yet active)

All three paths received DataSafe fixes to ensure consistency.

## Files Modified

### Bug Fixes

- `src/lib/oradba_common.sh`: PATH deduplication in load_config_file(), DataSafe adjustment in set_oracle_home_environment()
- `src/bin/oraenv.sh`: DataSafe ORACLE_HOME adjustment for oratab entries
- `src/lib/oradba_env_builder.sh`: DataSafe handling in Phase 2 builder
- `src/lib/oradba_env_config.sh`: Added debug logging (ORADBA_DEBUG=true)

### Release Documentation

- `VERSION`: Updated to 1.2.1
- `CHANGELOG.md`: Documented bug fixes
- `doc/releases/v1.2.1.md`: This file

## Upgrade Instructions

### From v1.2.0

```bash
# Backup current installation
cp -a /opt/oracle/local/oradba /opt/oracle/local/oradba.bak.1.2.0

# Download and extract v1.2.1
cd /tmp
wget https://github.com/oehrlis/oradba/releases/download/v1.2.1/oradba-1.2.1.tar.gz
tar -xzf oradba-1.2.1.tar.gz

# Run installer (preserves configurations)
cd oradba-1.2.1
./install.sh

# Reload environment
source ~/.bashrc
```

### Configuration Changes

No configuration changes required. This is a bug-fix-only release.

### Testing After Upgrade

1. **Test PATH deduplication:**

   ```bash
   # Source environment multiple times
   <sid> --silent
   pth | tee /tmp/path1.txt
   <sid> --silent
   pth | tee /tmp/path2.txt
   
   # Verify no duplicates added
   diff /tmp/path1.txt /tmp/path2.txt  # Should be identical
   ```

2. **Test DataSafe (if applicable):**

   ```bash
   # Switch to DataSafe connector
   <datasafe_name> --silent
   
   # Verify environment
   echo "ORACLE_HOME: $ORACLE_HOME"              # Should be .../oracle_cman_home
   echo "DATASAFE_HOME: $DATASAFE_HOME"          # Should match ORACLE_HOME
   echo "DATASAFE_INSTALL_DIR: $DATASAFE_INSTALL_DIR"  # Should be parent
   
   # Verify PATH
   pth | grep oracle_cman_home  # Should show .../oracle_cman_home/bin
   
   # Test DataSafe command
   cmctl status  # Should work without errors
   ```

## Known Issues

None reported for this release.

## Backward Compatibility

- ✅ 100% backward compatible with v1.2.0
- ✅ All configuration files compatible
- ✅ No breaking changes
- ✅ Existing workflows unaffected

## Credits

Special thanks to users who reported these issues and provided testing feedback:

- PATH accumulation issue: Discovered through repeated environment sourcing
- DataSafe ORACLE_HOME issue: Reported with specific test cases and expected behavior

## Support

- **Documentation:** <https://github.com/oehrlis/oradba>
- **Issues:** <https://github.com/oehrlis/oradba/issues>
- **Discussions:** <https://github.com/oehrlis/oradba/discussions>

## Next Release

v1.3.0 is planned for Q1 2026 with:

- Enhanced Phase 2 architecture features
- Additional product type support
- Performance improvements
- Extended test coverage

---

**Full Changelog:** <https://github.com/oehrlis/oradba/blob/main/CHANGELOG.md>
