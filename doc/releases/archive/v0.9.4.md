# OraDBA v0.9.4 - Database Status Display Improvements

Major improvements to `dbstatus.sh` with comprehensive handling of all database
states, dummy databases, and non-running instances.

## üéØ Key Improvements

### Database State Detection

- **Dummy Database Detection**: Automatically detects dummy SIDs (oratab `:D` flag)
  and shows environment info only‚Äîno SQL queries attempted
- **NOT STARTED Detection**: Properly identifies non-running databases using `v$instance` query instead of `dual`
- **MOUNT State Enhancement**: Extended MOUNT state display to show complete database information, matching OPEN state layout

### Enhanced Information Display

**MOUNT and OPEN States Now Show:**

- Database name, unique name, and DBID
- Datafile size (total GB)
- Database role (PRIMARY/STANDBY/SNAPSHOT STANDBY)
- Session information (user/oracle counts)
- PDB information (name and open mode)
- Log mode and character set
- Memory allocation (SGA/PGA)

**Special Handling:**

- Dummy databases: Environment variables only
- NOT STARTED databases: Clear status message, no errors
- All states: Consistent, informative output

## üîß Technical Changes

### New Features

- Added `is_dummy_sid()` function to [common.sh](https://github.com/oehrlis/oradba/blob/v0.9.4/src/lib/common.sh)
  - Checks oratab for `:D` flag before attempting connection
  - Prevents unnecessary SQL errors

### Database Functions ([db_functions.sh](https://github.com/oehrlis/oradba/blob/v0.9.4/src/lib/db_functions.sh))

- `check_database_connection()`: Changed from `SELECT FROM dual` to `SELECT status FROM v$instance`
- `query_database_info()`: Uses `v$nls_parameters` instead of `nls_database_parameters` (MOUNT state compatible)
- `query_sessions_info()`: Now works in MOUNT state (previously OPEN only)
- `query_pdb_info()`: Now works in MOUNT state (previously OPEN only)
- Improved error handling: Changed from `2>/dev/null` to `2>&1` with explicit grep filtering
- Removed `WHENEVER SQLERROR EXIT FAILURE` that caused silent failures
- Fixed whitespace handling in datafile size queries

### Display Order (Consistent Across States)

1. Environment (ORACLE_BASE, ORACLE_HOME, TNS_ADMIN, VERSION)
2. Database identity (DATABASE/DB_NAME/DB_UNIQUE_NAME with DBID)
3. Memory (MEMORY_SIZE with SGA/PGA)
4. Storage (FRA_SIZE, DATAFILE_SIZE)
5. Runtime (UPTIME, STATUS with role, USERS/SESSIONS)
6. Details (LOG_MODE, CHARACTERSET, PDB)

## üìä Example Output

### MOUNT State (NEW!)

```text
-------------------------------------------------------------------------------
ORACLE_BASE    : /opt/oracle
ORACLE_HOME    : /opt/oracle/product/23ai/dbhomeFree
TNS_ADMIN      : /opt/oracle/product/23ai/dbhomeFree/network/admin
ORACLE_VERSION : 23.0.0.0.0
-------------------------------------------------------------------------------
DATABASE       : FREE (Instance: FREE, DBID: 1489657696)
MEMORY_SIZE    : 1.5G SGA / 0G PGA (.5G pga_aggregate_target)
FRA_SIZE       : 10G
DATAFILE_SIZE  : 3.5G
UPTIME         : 2026-01-01 19:41:21 (0d 0h 8m)
STATUS         : MOUNTED / PRIMARY
USERS/SESSIONS : Non-Oracle: 0/0 , Oracle: 1/1
LOG_MODE       : ARCHIVELOG
CHARACTERSET   : AL32UTF8
PDB            : LABPDB1(MO), PDB$SEED(MO)
-------------------------------------------------------------------------------
```

### NOT STARTED

```text
-------------------------------------------------------------------------------
ORACLE_BASE    : /opt/oracle
ORACLE_HOME    : /opt/oracle/product/23ai/dbhomeFree
TNS_ADMIN      : /opt/oracle/product/23ai/dbhomeFree/network/admin
ORACLE_VERSION : 23.0.0.0.0
-------------------------------------------------------------------------------
STATUS         : NOT STARTED
-------------------------------------------------------------------------------
```

## üì¶ Installation

### Using the Installer (Recommended)

```bash
# Download and run
curl -LO https://github.com/oehrlis/oradba/releases/download/v0.9.4/oradba_install.sh
chmod +x oradba_install.sh
./oradba_install.sh
```

### Using the Distribution Tarball

```bash
# Download and extract
curl -LO https://github.com/oehrlis/oradba/releases/download/v0.9.4/oradba-0.9.4.tar.gz
tar -xzf oradba-0.9.4.tar.gz
cd oradba

# Install
./src/bin/oradba_install.sh --local
```

### Quick Test

```bash
# Source environment
source /opt/oradba/src/bin/oraenv.sh <SID>

# Check database status
dbstatus.sh
# or use alias
sta
```

## üîó Documentation

- **Full Documentation**: <https://github.com/oehrlis/oradba/tree/v0.9.4/src/doc>
- **Database Functions**: [10-functions.md](https://github.com/oehrlis/oradba/blob/v0.9.4/src/doc/10-functions.md)
- **Usage Guide**: [16-usage.md](https://github.com/oehrlis/oradba/blob/v0.9.4/src/doc/16-usage.md)
- **Changelog**: [CHANGELOG.md](https://github.com/oehrlis/oradba/blob/v0.9.4/CHANGELOG.md)

## üìù Commits in this Release

- df1da10 - fix(dbstatus): check dummy DB before connecting and improve error handling
- 0ad9d79 - fix(dbstatus): fix not-started detection and MOUNT state missing data
- 638082b - fix(dbstatus): use v$nls_parameters for MOUNT state compatibility
- 3ced456 - feat(dbstatus): extend MOUNT state display to match OPEN state
- 447c884 - fix(dbstatus): improve datafile size query whitespace handling
- 2f6c25e - chore: prepare release 0.9.4

**Full Changelog**: <https://github.com/oehrlis/oradba/compare/v0.9.3...v0.9.4>

## üôè Acknowledgments

Thanks to all users who reported issues and provided feedback on database status display!

---

**Oracle Database Infrastructure & Security Toolkit**  
**License**: Apache License 2.0  
**Author**: Stefan Oehrli (<stefan.oehrli@oradba.ch>)
