# Release v0.19.4 - Installer & AutoDiscovery Bug Fixes

**Release Date:** 2026-01-22  
**Type:** Bug Fix Release (Critical)  
**Focus:** Installer Configuration Handling + AutoDiscovery on Clean Installations

## Overview

This critical bug fix release addresses installer configuration file handling and multiple autodiscovery
issues. The fixes eliminate false "MODIFIED" warnings for user-managed configs during updates, ensure
accurate product detection, eliminate false positives, prevent over-discovery of nested installations,
and improve naming conventions.

## Critical Fixes

### 0. Installer Configuration File Handling (Issue #0 - NEW)

**Problem:** During updates, `etc/oradba_homes.conf` was reported as "MODIFIED" and backed up
as `.save`, even though this file is explicitly meant to be modified by users to register Oracle Homes.

Additionally, `src/etc/oradba_homes.conf` was incorrectly tracked in git with a leftover auto-discovered
OUD entry from testing.

**Root Cause:** The installer checksum generation included ALL files in `etc/`, treating
`oradba_homes.conf` as a core configuration file rather than a user-managed registry. The source file
was also mistakenly committed to the repository.

**Fix:**

- Excluded user-modifiable configuration files from checksum generation:
  - `etc/oradba_homes.conf` - Oracle Homes registry (user-managed)
  - `etc/oradba_customer.conf` - Customer overrides (user-managed)
  - `etc/oradba_local.conf` - Local site settings (user-managed)
  - `etc/sid.*.conf` - Per-database settings (user-managed)
- **Removed `src/etc/oradba_homes.conf` from git** - file should only exist as template
- File now properly generated from `src/templates/etc/oradba_homes.conf.template` during installation

**Changes:**

1. **Build Process** (`scripts/build_installer.sh`)
   - Modified checksum generation to skip user-modifiable configs
   - Added case statement to exclude user config patterns

2. **Installation Process** (`src/bin/oradba_install.sh`)
   - Added defensive skip logic for user configs in modification detection
   - Prevents backup of files that aren't in checksums

**Impact:**

- ✅ No confusing "MODIFIED" warnings for expected modifications
- ✅ User configurations preserved without unnecessary .save backups
- ✅ Cleaner update experience

### 1. OUD Home False Positive (Issue #1)

**Problem:** Non-existent OUD installations were reported during autodiscovery (e.g., `/tmp/tmp.yyl2yXoh9z/oracle/product/oud12`), even when no OUD component was present.

**Root Cause:** OUD plugin's `plugin_detect_installation()` function searched for directories named "oud" without validating they actually exist or contain OUD files.

**Fix:**
- Enhanced OUD plugin to validate directories exist before adding to results
- Added check to skip non-existent base directories
- Only outputs homes that pass validation checks

**Impact:** Eliminates spurious OUD entries in environment status displays.

### 2. Incorrect "Dummy" Entry Handling (Issue #2)

**Problem:** Installer added dummy entry (`dummy:/path/to/dummy:N`) even when real Oracle products existed, causing confusion.

**Root Cause:** Logic only checked if `/etc/oratab` existed, not whether actual Oracle products were present.

**Fix:**
- Modified `create_temp_oratab()` in `oradba_install.sh`
- Now checks for existing Oracle products (oracle, sqlplus, cmctl, java binaries)
- Dummy entry only added if:
  1. Explicitly requested via `--dummy-home`, OR
  2. No `/etc/oratab` exists AND no Oracle products found

**Impact:** Cleaner environment on systems with Oracle products installed.

### 3. Over-Discovery of Nested Installations (Issue #3)

**Problem:** Discovery created separate entries for:
- JRE inside JDK (e.g., both `jdk1.8.0_471` and `jdk1.8.0_471/jre`)
- iClient libraries inside DataSafe (e.g., `oracle_cman_home/lib`)

**Root Cause:** Plugin detection didn't check for nested installations.

**Fixes:**

#### Java Plugin
- Excludes JRE subdirectories within JDK installations
- Checks if parent has `javac` (indicating JDK)
- Only reports standalone JRE installations

#### iClient Plugin
- Excludes libraries found inside DataSafe `oracle_cman_home` directories
- Excludes libraries inside Database homes (has `bin/oracle` or `rdbms/`)
- Excludes libraries inside Full Client homes (has `bin/sqlplus`)

#### detect_product_type() Function
- Added check for JRE inside JDK (returns "unknown")
- Moved DataSafe detection before iClient detection
- Added check to exclude `oracle_cman_home` paths from iClient detection

**Impact:** Eliminates duplicate and incorrect product entries.

### 4. Naming Convention Improvements (Issue #4)

**Problem:** DataSafe naming used `dsconn` pattern (verbose names like `EXACC_WOB_VWG_HA2`)

**Fix:**
- Fixed typo: `dsconn` → `dscon` (consistent with user feedback)
- Improved naming patterns:
  - JDK: `jdk8`, `jdk11`, `jdk17`
  - JRE: `jre8` (for standalone JRE only)
  - DataSafe: `dscon1`, `dscon2`
  - iClient: `iclient19`, `iclient23`

**Impact:** More usable and consistent naming conventions.

### 5. User Guidance (Issue #5)

**Problem:** No indication that discovered entries could be customized.

**Fix:**
- Added note in autodiscovery output:
  ```
  Note: Discovered entries can be customized in /path/to/oradba_homes.conf
        You can edit the file to change names, order, or descriptions.
  ```

**Impact:** Users aware they can customize discovered entries.

## Files Changed

- `src/lib/plugins/oud_plugin.sh` - Validate homes exist before reporting
- `src/lib/plugins/java_plugin.sh` - Exclude nested JRE directories
- `src/lib/plugins/iclient_plugin.sh` - Exclude libraries in product homes
- `src/lib/oradba_common.sh` - Improved `detect_product_type()` logic
- `src/bin/oradba_install.sh` - Smart dummy entry logic

## Testing Recommendations

After upgrading to v0.19.4:

1. **Clean Install Test:**
   ```bash
   ./oradba_install.sh --base /opt/oracle --update-profile
   source ~/.bashrc
   oraup --status
   ```
   - Verify no spurious OUD entries
   - Verify dummy entry only if no Oracle products exist

2. **Existing Installation Test:**
   ```bash
   # Backup current config
   cp ${ORADBA_PREFIX}/etc/oradba_homes.conf ${ORADBA_PREFIX}/etc/oradba_homes.conf.backup
   
   # Remove and rediscover
   rm ${ORADBA_PREFIX}/etc/oradba_homes.conf
   oradba_homes.sh discover --auto-add
   
   # Review discovered entries
   cat ${ORADBA_PREFIX}/etc/oradba_homes.conf
   ```
   - Verify no duplicate JRE entries
   - Verify no iClient entries for DataSafe libs
   - Verify naming conventions (dscon1, jdk8, etc.)

3. **Mixed Environment Test:**
   Test with combinations of:
   - JDK with embedded JRE
   - DataSafe with oracle_cman_home
   - Standalone iClient
   - Database homes

## Upgrade Notes

### For Users with Existing Installations

- **No action required** - Existing `oradba_homes.conf` entries remain unchanged
- **Optional:** Run rediscovery to clean up duplicate entries:
  ```bash
  # Backup current config
  cp ${ORADBA_PREFIX}/etc/oradba_homes.conf ${ORADBA_PREFIX}/etc/oradba_homes.conf.v0193
  
  # Remove duplicates manually or rediscover
  vi ${ORADBA_PREFIX}/etc/oradba_homes.conf
  ```

### For New Installations

- No special steps needed
- Autodiscovery will now work correctly on clean systems
- Customize discovered entries in `oradba_homes.conf` as needed

## Known Limitations

- Discovery limited to directories under `ORACLE_BASE/product` and common locations
- Custom installation paths may need manual registration
- Plugin detection based on file/directory signatures (may miss non-standard setups)

## Related Issues

- Fixes bug report: "AutoDiscovery and Environment Setup produce incorrect entries on clean install"
- Addresses all 5 reported issues:
  1. OUD false positive
  2. Dummy entry logic
  3. Over-discovery (JRE, iClient)
  4. Naming conventions
  5. User guidance

## Compatibility

- **Backward Compatible:** Yes
- **Configuration Changes:** None required
- **Breaking Changes:** None
- **Minimum Requirements:** Same as v0.19.3

## Next Steps

- Continue monitoring autodiscovery accuracy in various environments
- Consider adding configuration option for custom discovery paths
- Enhance plugin validation for edge cases

## Feedback

If you encounter any issues with autodiscovery after upgrading:
1. Enable debug logging: `export ORADBA_LOG_LEVEL=DEBUG`
2. Run discovery: `oradba_homes.sh discover --auto-add`
3. Report findings to: https://github.com/oehrlis/oradba/issues
