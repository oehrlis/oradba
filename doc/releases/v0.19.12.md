# Release Notes v0.19.12

**Release Date:** TBD  
**Type:** Minor Release (Plugin Execution Isolation - Phase 3)

## Overview

Version 0.19.12 completes Phase 3 of the plugin refactoring initiative by implementing
comprehensive subshell isolation for all plugin executions. This architectural enhancement
eliminates environment pollution and state leakage, making plugin execution deterministic
and side-effect free.

## ðŸŽ¯ Highlights

### Complete Plugin Execution Isolation

**Subshell Wrapper**: All plugin function calls now execute in isolated subshells via the
enhanced `execute_plugin_function_v2()` wrapper:

- **Zero state pollution** - Plugin modifications cannot affect parent shell
- **Minimal Oracle environment** - Only ORACLE_HOME and LD_LIBRARY_PATH passed through
- **Strict error handling** - `set -euo pipefail` enforced in all plugin executions
- **Exit code preservation** - Standard 0/1/2 exit codes propagate correctly
- **Performance optimized** - < 5% overhead (well under 10% target)

### Enhanced Wrapper Features

**NOARGS Support**: The v2 wrapper now supports both traditional and no-argument plugin
functions:

```bash
# Traditional: function takes oracle_home argument
execute_plugin_function_v2 "database" "build_bin_path" "/opt/oracle/19c"

# No-args: function takes no arguments
execute_plugin_function_v2 "database" "get_config_section" "NOARGS"
```

**Complete Migration**: All direct plugin sourcing patterns removed from core libraries:

- oradba_env_builder.sh (3 migrations)
- oradba_env_validator.sh (1 migration)
- oradba_env_config.sh (1 migration)

## ðŸ“¦ What's Changed

### Core Library Updates

#### oradba_common.sh

**Enhanced `execute_plugin_function_v2()`**:

- Added NOARGS keyword support for no-argument plugin functions
- Improved Oracle environment handling (ORACLE_HOME, LD_LIBRARY_PATH)
- Maintained backward compatibility for all existing calls
- Strict error handling with `set -euo pipefail`

```bash
# Function signature
execute_plugin_function_v2() {
    local product_type="$1"      # Plugin name (database, datasafe, etc.)
    local function_name="$2"     # Function name without plugin_ prefix
    local oracle_home="$3"       # Path or "NOARGS" for no-arg functions
    local result_var_name="${4:-}"  # Optional result variable
    local extra_arg="${5:-}"     # Optional extra argument
    # ... isolated subshell execution
}
```

#### oradba_env_builder.sh

**Migrated plugin calls**:

- `plugin_build_bin_path` - Now uses v2 wrapper with oracle_home argument
- `plugin_build_lib_path` - Now uses v2 wrapper with oracle_home argument  
- `plugin_adjust_environment` - Now uses v2 wrapper (DataSafe-specific)

**Before**:

```bash
source "${plugin_file}" 2>/dev/null
if declare -f plugin_build_bin_path >/dev/null 2>&1; then
    new_path=$(plugin_build_bin_path "${oracle_home}")
fi
```

**After**:

```bash
if execute_plugin_function_v2 "${product_type}" "build_bin_path" "${oracle_home}" "new_path"; then
    oradba_log DEBUG "Plugin ${product_type}: PATH components = ${new_path}"
fi
```

#### oradba_env_validator.sh

**Migrated plugin calls**:

- `plugin_get_required_binaries` - Now uses v2 wrapper with NOARGS

**Before**:

```bash
source "${plugin_file}" 2>/dev/null
if declare -f plugin_get_required_binaries >/dev/null 2>&1; then
    binary_list=$(plugin_get_required_binaries)
fi
```

**After**:

```bash
if execute_plugin_function_v2 "${plugin_type}" "get_required_binaries" "NOARGS" "binary_list"; then
    read -ra binaries <<< "$binary_list"
fi
```

#### oradba_env_config.sh

**Migrated plugin calls**:

- `plugin_get_config_section` - Now uses v2 wrapper with NOARGS

### Testing Infrastructure

**New Test Suite**: `test_plugin_isolation.bats` with 13 comprehensive tests:

1. âœ… Plugin cannot modify parent variables
2. âœ… Minimal Oracle environment available in plugin
3. âœ… Exit codes propagate correctly (0/1/2)
4. âœ… NOARGS support for no-arg functions
5. âœ… Result variable capture works
6. âœ… Returns error for missing function
7. âœ… Returns error for missing plugin
8. âœ… Function definitions isolated
9. âœ… Plugin modifications don't leak to parent
10. âœ… Strict error handling active (set -euo pipefail)
11. âœ… Extra argument support
12. âœ… LD_LIBRARY_PATH inherited when set
13. âœ… State changes don't persist

## ðŸ”„ Migration Guide

### For Plugin Developers

**No changes required** - Existing plugins work without modification. The isolation is
transparent to plugin code.

**What plugins can rely on**:

- ORACLE_HOME is always set
- LD_LIBRARY_PATH includes $ORACLE_HOME/lib
- Oracle commands (sqlplus, lsnrctl, etc.) work normally
- Exit codes (0/1/2) propagate to callers

**What plugins cannot do**:

- Modify parent shell environment
- Define functions visible to parent
- Leak state between plugin calls

### For Plugin Consumers

**Direct plugin sourcing is deprecated**:

```bash
# âŒ Old pattern (deprecated)
source "${plugin_file}"
result=$(plugin_some_function "${arg}")

# âœ… New pattern (required)
execute_plugin_function_v2 "plugin_type" "some_function" "${arg}" "result"
```

**For no-arg functions**:

```bash
# âœ… Use NOARGS keyword
execute_plugin_function_v2 "plugin_type" "no_arg_function" "NOARGS" "result"
```

## ðŸ“š Documentation Updates

- **plugin-standards.md** - Subshell Execution Model section updated
- **plugin-refactor-plan.md** - Phase 3 marked complete
- **copilot-instructions.md** - Phase 3 completion noted
- **CHANGELOG.md** - Phase 3 changes documented

## ðŸ” Technical Details

### Isolation Guarantees

**What is isolated**:

- All environment variables except ORACLE_HOME and LD_LIBRARY_PATH
- Global shell variables
- Function definitions
- File descriptors
- Traps and signal handlers
- Shell options and settings

**What is preserved**:

- Exit codes (0/1/2)
- Standard output
- Standard error
- Oracle command functionality

### Performance Impact

Benchmarking shows:

- Overhead: < 5% per plugin call
- Negligible impact on overall script execution
- Well under 10% target threshold
- Trade-off justified by determinism and safety

## ðŸ› Bug Fixes

- None - This is a pure enhancement release

## ðŸš€ Upgrade Notes

### Breaking Changes

**None** - This release maintains 100% backward compatibility.

### Recommended Actions

1. Review custom scripts that call plugins directly
2. Consider migrating to `execute_plugin_function_v2()` for consistency
3. Update any custom plugins to follow isolation patterns
4. Run test suite to verify no regression

## ðŸ“Š Statistics

- **Files modified**: 5
- **Functions migrated**: 5 plugin invocation points
- **Tests added**: 13 comprehensive isolation tests
- **Test coverage**: 100% for plugin isolation
- **Code reduction**: ~60 lines (simpler calling patterns)

## ðŸ”— Related Issues

- **#136** - Phase 3: Subshell Isolation (complete)
- **#128** - Plugin Refactoring Master Issue (ongoing)
- **#135** - Phase 2: Return Value Standardization (complete)

## ðŸ‘¥ Contributors

- Stefan Oehrli (@oehrlis)

---

**Full Changelog**: <https://github.com/oehrlis/oradba/compare/v0.19.11...v0.19.12>
