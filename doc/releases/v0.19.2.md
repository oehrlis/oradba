# OraDBA v0.19.2 Release Notes

**Release Date:** 2026-01-21  
**Release Type:** Enhancement + Bug Fix  
**Focus:** Oracle Homes Auto-Discovery + oraup.sh Display Improvements

## Overview

OraDBA v0.19.2 introduces enhanced Oracle Homes auto-discovery capabilities, fixes display issues in
non-database environments, and improves shell compatibility. This release focuses on improving the
experience for Data Safe, client-only, and mixed Oracle product installations, while ensuring better
compatibility across different terminal environments.

## What's New

### Enhanced Oracle Homes Auto-Discovery (Issue #70)

Automatic discovery and registration of Oracle installations during environment initialization or via management commands.

**Key Features:**

- **Auto-Discovery on Login**: Optionally scan for Oracle installations when loading the environment
- **Unified Discovery Function**: Single `auto_discover_oracle_homes()` used by all tools
- **Smart Product Detection**: Leverages plugin system to identify all Oracle product types
- **Intelligent Naming**: Generates meaningful home names based on product type and version
- **Duplicate Prevention**: Silently skips already-registered installations

**Configuration:**

```bash
# Enable auto-discovery on environment load (default: false, opt-in)
export ORADBA_AUTO_DISCOVER_HOMES="true"

# Customize discovery paths (default: ${ORACLE_BASE}/product)
export ORADBA_DISCOVERY_PATHS="${ORACLE_BASE}/product /opt/oracle"
```

**Usage Examples:**

```bash
# Automatic discovery on first login (if enabled)
source oraenv.sh
# Auto-discovers and registers all Oracle Homes

# Manual discovery via management tool
oradba_homes.sh discover --auto-add
# Scans and adds all found Oracle Homes

# Discovery with custom path
oradba_homes.sh discover --base /u01/oracle --auto-add
```

**Smart Name Generation:**

| Product Type   | Example Directory   | Generated Name |
| -------------- | ------------------- | -------------- |
| Java           | jdk-17.0.1          | jdk17          |
| Instant Client | instantclient_26_10 | iclient26      |
| Data Safe      | exacc-wob-vwg-ha1   | dsconn01       |
| Database       | dbhome_19_18        | rdbms1918      |
| Full Client    | client_19_18        | client1918     |
| OUD            | oud12.2.1.4         | oud1221        |
| WebLogic       | wls14.1.1           | wls1411        |

### Improved Shell Compatibility

Enhanced `oradba_check.sh` for better cross-platform compatibility:

**ASCII-Compatible Output:**

- Replaced Unicode special characters with ASCII alternatives
- `✓` → `[OK]` for successful checks
- `✗` → `[FAIL]` for failed checks  
- `⚠` → `[WARN]` for warnings
- `ℹ` → `[INFO]` for informational messages

**Benefits:**

- Consistent display across all shell environments
- Compatible with older terminal emulators
- Works correctly in non-UTF8 terminals
- Better accessibility for screen readers

### oraup.sh Display Improvements (Issue #99)

Fixed display issues that caused confusion in non-database Oracle environments.

**Problems Resolved:**

1. **Listener Section Always Shown**
   - Previously displayed "No database listeners running" even in Data Safe-only environments
   - Now only shown when database SIDs exist or database listeners are running
   - Cleaner output for client-only, Data Safe, or non-database installations

2. **Data Safe Status Hardcoded**
   - Previously always showed "N/A" or "available" regardless of actual state
   - Now uses real plugin status via `oradba_check_datasafe_status()`
   - Shows accurate status: running, stopped, unavailable, empty, unknown

3. **Dummy Entries Displayed**
   - Previously showed dummy database entries when no oratab existed
   - Now skips dummy entries (flag 'D') in Oracle Homes section
   - Eliminates confusion in Data Safe-only environments

**Before (Data Safe Environment):**

```text
Oracle Homes
------------------------------------------------------------------------------------------
NAME                 TYPE             STATUS        ORACLE_HOME
------------------------------------------------------------------------------------------
dummy (dummy)        database         down          /appl/oracle/product/dummy

Database Instances
------------------------------------------------------------------------------------------
SID                  FLAG             STATUS        ORACLE_HOME
------------------------------------------------------------------------------------------
dummy                N                down          /appl/oracle/product/dummy

------------------------------------------------------------------------------------------
NAME                 PORT (tcp/tcps)  STATUS        ORACLE_HOME
------------------------------------------------------------------------------------------
  No database listeners running

Data Safe Connectors
------------------------------------------------------------------------------------------
NAME                 PORT (tcp/tcps)  STATUS        DATASAFE_BASE_HOME
------------------------------------------------------------------------------------------
dsconn1              n/a              N/A           /appl/oracle/product/exacc-wob-vwg-ha1
```

**After (Data Safe Environment):**

```text
Oracle Homes
------------------------------------------------------------------------------------------
NAME                 TYPE             STATUS        ORACLE_HOME
------------------------------------------------------------------------------------------
jdk18                java             available     /appl/oracle/product/jdk1.8.0_471
iclient26            iclient          available     /appl/oracle/product/iclient26

Data Safe Connectors
------------------------------------------------------------------------------------------
NAME                 PORT (tcp/tcps)  STATUS        DATASAFE_BASE_HOME
------------------------------------------------------------------------------------------
dsconn1              2484/2484        running       /appl/oracle/product/exacc-wob-vwg-ha1
dsconn2              2485/2485        running       /appl/oracle/product/exacc-wob-vwg-ha2
dsconn3              n/a              stopped       /appl/oracle/product/exacc-wob-vwg-ha3
```

## Technical Details

### Auto-Discovery Architecture

**Unified Function:**

- **Location:** `src/lib/oradba_common.sh`
- **Function:** `auto_discover_oracle_homes()`
- **Parameters:**
  - `$1` - Discovery paths (optional, defaults to `ORADBA_DISCOVERY_PATHS`)
  - `$2` - Silent mode flag (optional, "true" for silent, default: false)
- **Returns:** 0 on success, 1 on error
- **Output:** Discovery summary (unless silent mode)

**Integration Points:**

1. **oraenv.sh** - Environment initialization
   - Triggered after instance auto-discovery
   - Only runs if `ORADBA_AUTO_DISCOVER_HOMES=true`
   - Uses silent mode to avoid noise during login

2. **oradba_homes.sh discover** - Management command
   - Always available for manual discovery
   - Supports `--auto-add` flag to register found homes
   - Provides verbose output for interactive use

**Discovery Process:**

1. Scan configured paths up to 3 levels deep
2. Call `detect_product_type()` for each directory
3. Skip unknown types and symbolic links
4. Generate smart home name based on product type
5. Check for duplicates (by name and by path)
6. Add to `oradba_homes.conf` if new
7. Log results and summary

### Display Logic Changes

**Listener Section Visibility:**

```bash
# Only show if database installations exist OR database listeners running
local total_databases=$((${#database_sids[@]}))
local has_database_listeners=false

if ps -ef 2>/dev/null | grep "[t]nslsnr" | \
    grep -qv "datasafe\|oracle_cman_home"; then
    has_database_listeners=true
fi

if [[ $total_databases -gt 0 ]] || [[ "$has_database_listeners" == "true" ]]; then
    # Show listener section
fi
```

**Data Safe Status:**

```bash
# Use real plugin status
if command -v oradba_check_datasafe_status &>/dev/null; then
    status=$(oradba_check_datasafe_status "$home" 2>/dev/null | \
        tr '[:upper:]' '[:lower:]')
    [[ -z "$status" ]] && status="unknown"
fi
```

**Dummy Entry Filtering:**

```bash
# Skip dummy entries in Oracle Homes section
if [[ "$flags" == "D" ]]; then
    continue
fi
```

## Upgrade Notes

### For Auto-Discovery

**Opt-In Feature:**

Auto-discovery is **disabled by default** for backward compatibility. To enable:

```bash
# In oradba_customer.conf
export ORADBA_AUTO_DISCOVER_HOMES="true"
```

**First-Time Setup:**

If enabling auto-discovery on an existing system with Oracle installations:

```bash
# 1. Enable in config
echo 'export ORADBA_AUTO_DISCOVER_HOMES="true"' >> ${ORADBA_PREFIX}/etc/oradba_customer.conf

# 2. Run manual discovery first time
oradba_homes.sh discover --auto-add

# 3. Verify
oradba_homes.sh list

# 4. Future logins will maintain the registry automatically
```

**Custom Discovery Paths:**

If Oracle products are in non-standard locations:

```bash
# In oradba_customer.conf
export ORADBA_DISCOVERY_PATHS="${ORACLE_BASE}/product /opt/oracle /u01/oracle"
```

### For oraup.sh Improvements

**No Action Required:**

Display improvements are automatic and backward compatible. Existing environments will see cleaner,
more relevant output immediately after upgrade.

**Data Safe Environments:**

Users with Data Safe connectors will now see accurate status information. Ensure the Data Safe
plugin is properly loaded (automatic in v0.19.x+).

## Testing

### Auto-Discovery Testing

```bash
# Test detection function
source ${ORADBA_PREFIX}/lib/oradba_common.sh
detect_product_type "/path/to/oracle/home"

# Test auto-discovery (dry run)
export ORADBA_DISCOVERY_PATHS="/appl/oracle/product"
auto_discover_oracle_homes "$ORADBA_DISCOVERY_PATHS" "false"

# Test via oradba_homes.sh
oradba_homes.sh discover --base /appl/oracle
oradba_homes.sh discover --base /appl/oracle --auto-add
```

### Display Testing

```bash
# Test oraup.sh in different environments
oraup.sh  # or alias: u

# Data Safe environment should show:
# - No dummy entries
# - No listener section (if no database)
# - Real Data Safe status

# Mixed environment should show:
# - Database instances section
# - Listener section (if listeners running)
# - Data Safe section with real status
```

## Known Issues

None specific to v0.19.2 changes.

## Breaking Changes

None. All changes are backward compatible:

- Auto-discovery is opt-in (default: false)
- Display improvements enhance existing behavior
- Configuration variables have sensible defaults

## Migration Guide

### From v0.19.0/v0.19.1

1. **Update OraDBA:**

   ```bash
   cd /opt/oradba
   git pull
   # Or reinstall using installer
   ```

2. **Optional: Enable Auto-Discovery:**

   ```bash
   # Add to oradba_customer.conf
   export ORADBA_AUTO_DISCOVER_HOMES="true"
   
   # Initial discovery
   oradba_homes.sh discover --auto-add
   ```

3. **Verify:**

   ```bash
   oradba_homes.sh list
   oraup.sh
   ```

### From Earlier Versions

Follow the standard upgrade path to v0.19.0+ first, then apply this update.

## Documentation

- [Oracle Homes Management](../src/doc/oracle-homes.md)
- [Configuration Guide](../src/doc/configuration.md)
- [Extension System](../extension-system.md)

## Contributors

- Stefan Oehrli (oes) - <stefan.oehrli@oradba.ch>

## References

- Issue #70: Enhanced Oracle Homes Auto-Scan
- Issue #99: oraup.sh incorrectly displays listener/status sections for Data Safe environments
- Commit: 40d2f54

---

**Full Changelog:** [v0.19.1...v0.19.2](https://github.com/oehrlis/oradba/compare/v0.19.1...v0.19.2)
