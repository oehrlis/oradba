# Release Notes v0.20.0

**Release Date:** 2026-02-09  
**Type:** Major Release (Plugin System & Environment Management Improvements)

## Overview

Version 0.20.0 represents a significant milestone in OraDBA's evolution, consolidating
three major enhancement phases: plugin interface improvements (v0.19.11), subshell
isolation architecture (v0.19.12), and critical bug fixes for production reliability.
This release enhances the plugin system with comprehensive environment management,
eliminates false positives in Oracle Home discovery, and improves dummy entry handling
across all environment tools.

## ðŸŽ¯ Major Highlights

### Plugin System Enhancements (v0.19.11 + v0.19.12)

**Enhanced Plugin Interface (v1.0.0)**:
- Split generic `plugin_build_path` into specialized `plugin_build_bin_path` and
  `plugin_build_lib_path` functions
- Added `plugin_build_base_path` for resolving ORACLE_BASE_HOME vs ORACLE_HOME
- Added `plugin_build_env` for unified environment variable generation
- Added `plugin_get_instance_list` for multi-instance product enumeration
- Separated listener logic with `plugin_should_show_listener` and
  `plugin_check_listener_status` for category-specific handling

**Complete Subshell Isolation**:
- All plugin functions execute in isolated subshells via `execute_plugin_function_v2()`
- Zero state pollution - plugin modifications cannot affect parent shell
- Minimal Oracle environment - only ORACLE_HOME and LD_LIBRARY_PATH passed through
- NOARGS support for no-argument functions
- Performance overhead < 5% (well under 10% target)

### Critical Bug Fixes

**Plugin System Reliability**:
- Fixed exit code 133 issue caused by overly strict error handling
- Removed `set -euo pipefail` from plugin subshells for better flexibility
- Added defensive sourcing of oradba_common.sh in oradba_env_status.sh
- DataSafe connector status now correctly shows stopped/unavailable instead of "unknown"

**Oracle Home Discovery**:
- Eliminated false positives from bundled components (jdk, lib, inventory)
- Implemented plugin-based validation with parent directory exclusion
- Discovery now validates each path using `plugin_validate_home()` before accepting
- Automatically skips subdirectories of already-validated Oracle Homes

**Environment Management**:
- Enhanced dummy entry handling with clear flag column display
- `oradba_env.sh list sids` shows DUMMY/AUTO-START/MANUAL flags
- `oradba_env.sh show` defaults to current $ORACLE_SID if not specified
- `oraup.sh` clearly marks dummy entries as "dummy (â†’REAL_SID)"

## ðŸ“¦ What's Changed

### Plugin Interface Updates

#### New Functions (v0.19.11)

All plugins now implement these additional functions:

```bash
# Resolve installation base path
plugin_build_base_path()
  Args: $1 - Input ORACLE_HOME or ORACLE_BASE_HOME
  Returns: 0=success
  Output: Normalized base path

# Build complete environment
plugin_build_env()
  Args: $1 - ORACLE_HOME, $2 - Instance/domain identifier (optional)
  Returns: 0=success, 1=n/a, 2=unavailable
  Output: Key=value pairs (one per line)

# Get PATH components
plugin_build_bin_path()
  Args: $1 - ORACLE_HOME path
  Returns: 0=success
  Output: Colon-separated PATH components

# Get LD_LIBRARY_PATH components
plugin_build_lib_path()
  Args: $1 - ORACLE_HOME path
  Returns: 0=success
  Output: Colon-separated library path components

# Enumerate instances/domains
plugin_get_instance_list()
  Args: $1 - ORACLE_HOME path
  Returns: 0=success
  Output: instance_name|status|metadata (one per line)

# Category-specific: Show listener?
plugin_should_show_listener()
  Args: None
  Returns: 0=yes, 1=no
  Output: None

# Category-specific: Check listener status
plugin_check_listener_status()
  Args: $1 - ORACLE_HOME path
  Returns: 0=running, 1=stopped, 2=unavailable
  Output: Status string
```

#### Removed Functions

- `plugin_build_path` (deprecated) - Replaced by `plugin_build_bin_path` and
  `plugin_build_lib_path`

### Core Library Updates (v0.19.12)

#### execute_plugin_function_v2 Enhancements

```bash
# Enhanced function signature with NOARGS support
execute_plugin_function_v2() {
    local product_type="$1"      # Plugin name (database, datasafe, etc.)
    local function_name="$2"     # Function name without plugin_ prefix
    local oracle_home="$3"       # Path or "NOARGS" for no-arg functions
    local result_var_name="${4:-}"  # Optional result variable
    local extra_arg="${5:-}"     # Optional extra argument
    # ... isolated subshell execution
}
```

**Usage Examples**:

```bash
# Traditional: function takes oracle_home argument
execute_plugin_function_v2 "database" "build_bin_path" "/opt/oracle/19c" "path"

# No-args: function takes no arguments
execute_plugin_function_v2 "database" "get_config_section" "NOARGS" "section"

# With extra argument
execute_plugin_function_v2 "database" "check_status" "/opt/oracle/19c" "status" "ORCL"
```

#### Migrated Plugin Calls

**oradba_env_builder.sh**:
- `plugin_build_bin_path` â†’ uses v2 wrapper
- `plugin_build_lib_path` â†’ uses v2 wrapper
- `plugin_adjust_environment` â†’ uses v2 wrapper

**oradba_env_validator.sh**:
- `plugin_get_required_binaries` â†’ uses v2 wrapper with NOARGS

**oradba_env_config.sh**:
- `plugin_get_config_section` â†’ uses v2 wrapper with NOARGS

### Bug Fixes

#### Oracle Home Discovery (Issue #143)

**Problem**: False positives detected bundled components as separate Oracle Homes:
- `/opt/oracle/product/26ai/dbhomeFree/jdk` (bundled JDK)
- `/opt/oracle/product/26ai/dbhomeFree/lib` (Oracle libraries)

**Solution**:
- Added `is_subdirectory_of_oracle_home()` helper function
- Added `is_bundled_component()` for common component detection
- Enhanced `auto_discover_oracle_homes()` with validation tracking
- Discovery now validates with `plugin_validate_home()` before accepting
- Skips subdirectories of already-validated homes

#### Plugin System Exit Code 133 (Issue #144)

**Problem**: Plugins failing with signal termination (exit code 133):
- Strict `set -euo pipefail` in subshells too restrictive for plugin operations
- DataSafe connector consistently showing "unknown" status
- Plugins unable to check conditions that might naturally fail

**Solution**:
- Removed `set -euo pipefail` from `execute_plugin_function_v2` subshells
- Added defensive sourcing of oradba_common.sh in oradba_env_status.sh
- Fixed syntax error in oraup.sh DataSafe status detection
- Plugins now have flexibility to check conditions without subshell termination
- Added comprehensive debug logging for plugin diagnostics

#### Dummy Entry Handling (Issue #138)

**Problem**: Dummy SIDs not clearly distinguished in output:
- `oradba_env.sh list sids` showed all entries without distinction
- `oraup.sh` listed dummy entries without marking them
- Confusion about which entries were real databases vs aliases

**Solution**:
- Added flag column to `oradba_env.sh list sids` showing:
  - `DUMMY` for alias entries (flag 'D')
  - `AUTO-START` for auto-starting databases (flag 'Y')
  - `MANUAL` for manually-started databases (flag 'N')
- `oraup.sh` now marks dummy entries as "dummy (â†’REAL_SID)"
- Dummy entries visible in Oracle Homes section for transparency
- Real databases only in Database Instances section

### User Interface Improvements

**oradba_env.sh**:
```bash
# New flag column in list sids output
$ oradba_env.sh list sids
ORACLE_SID          FLAG         ORACLE_HOME
----------------------------------------------------------
ORCL                AUTO-START   /u01/app/oracle/product/19c
CDB1                MANUAL       /u01/app/oracle/product/19c
alias_db            DUMMY        /u01/app/oracle/product/19c

# Now defaults to current $ORACLE_SID
$ export ORACLE_SID=ORCL
$ oradba_env.sh show
# Shows ORCL info (no need to specify)

# Cleaner status output (removed blank lines)
$ oradba_env.sh status
Database: ORCL
Status: OPEN
Listener: running
```

**oraup.sh**:
```
Oracle Homes
------------------------------------------------------------------------------------------
NAME                 TYPE             STATUS        ORACLE_HOME
------------------------------------------------------------------------------------------
alias_db             database         dummy (â†’ORCL) /u01/app/oracle/product/19c
ora19c               database         available     /u01/app/oracle/product/19c

Database Instances
------------------------------------------------------------------------------------------
SID                  FLAG             STATUS        ORACLE_HOME
------------------------------------------------------------------------------------------
ORCL                 Y                open          /u01/app/oracle/product/19c
CDB1                 N                stopped       /u01/app/oracle/product/19c
```

## ðŸ”§ Action Required for Plugin Authors

### Plugin Interface Updates (v0.19.11)

If you maintain custom OraDBA plugins, update them to implement the new functions:

1. **Split path building logic**:
   ```bash
   # Replace this:
   plugin_build_path() {
       echo "${ORACLE_HOME}/bin:${ORACLE_HOME}/OPatch"
   }
   
   # With these two functions:
   plugin_build_bin_path() {
       echo "${ORACLE_HOME}/bin:${ORACLE_HOME}/OPatch"
   }
   
   plugin_build_lib_path() {
       echo "${ORACLE_HOME}/lib"
   }
   ```

2. **Add environment functions**:
   ```bash
   plugin_build_base_path() {
       echo "${ORACLE_HOME}"  # Or resolve ORACLE_BASE_HOME
   }
   
   plugin_build_env() {
       local home="$1"
       local instance="${2:-}"
       echo "ORACLE_HOME=${home}"
       echo "PATH=$(plugin_build_bin_path "${home}"):${PATH}"
       echo "LD_LIBRARY_PATH=$(plugin_build_lib_path "${home}"):${LD_LIBRARY_PATH}"
   }
   
   plugin_get_instance_list() {
       local home="$1"
       # List instances for multi-instance products
   }
   ```

3. **Add listener functions (if applicable)**:
   ```bash
   plugin_should_show_listener() {
       return 0  # For database products; return 1 for others
   }
   
   plugin_check_listener_status() {
       local home="$1"
       # Check listener status
   }
   ```

### Migration from Direct Plugin Calls (v0.19.12)

**Old pattern (deprecated)**:
```bash
source "${plugin_file}"
result=$(plugin_some_function "${arg}")
```

**New pattern (required)**:
```bash
execute_plugin_function_v2 "plugin_type" "some_function" "${arg}" "result"
```

**For no-arg functions**:
```bash
execute_plugin_function_v2 "plugin_type" "no_arg_function" "NOARGS" "result"
```

## ðŸ”„ Compatibility

- **Backward Compatible**: Existing plugins continue to work (graceful degradation)
- **No Breaking Changes**: All existing functionality preserved
- **Recommended Migration**: Update custom plugins to use new interface for full features

## ðŸ“Š Statistics

- **Total Tests**: 1086 tests across 37 test files (100% passing)
- **Function Documentation**: 437 functions (100% documented)
- **Plugin Interface**: v1.0.0 (13 universal + category-specific functions)
- **Plugin Isolation Tests**: 13 comprehensive tests
- **Code Changes**: 5 core libraries migrated to isolated execution
- **Performance**: < 5% overhead from subshell isolation

## ðŸ› Related Issues

- **#128** - Plugin Refactoring Master Issue
- **#135** - Phase 2: Return Value Standardization (complete)
- **#136** - Phase 3: Subshell Isolation (complete)
- **#138** - Dummy Entry Handling Improvements (complete)
- **#143** - Oracle Home Discovery False Positives (complete)
- **#144** - Plugin System Exit Code 133 (complete)

## ðŸ“š Documentation Updates

- Updated `doc/plugin-standards.md` with complete interface specification
- Updated `doc/plugin-development.md` with implementation examples
- Updated `.github/copilot-instructions.md` with development patterns
- Added `doc/quickstart.md` enhancements for dummy entry handling
- Added `doc/advanced-configuration.md` Oracle Homes management updates
- Updated plugin refactor plan tracking documents

## ðŸš€ Upgrade Notes

### Standard Upgrade

```bash
# Update OraDBA
bash oradba_install.sh --update

# Verify version
oradba_version.sh --check
# Should show: OraDBA v0.20.0

# Test plugin system
export ORADBA_LOG_LEVEL=DEBUG
oraup.sh
# Should show clean status output with no "unknown" entries
```

### Testing Recommendations

1. **Test Oracle Home discovery**:
   ```bash
   oradba_homes.sh discover
   # Should not show bundled components
   ```

2. **Test dummy entry handling**:
   ```bash
   oradba_env.sh list sids
   # Should show flag column (DUMMY/AUTO-START/MANUAL)
   ```

3. **Test plugin status checks**:
   ```bash
   oraup.sh
   # DataSafe connectors should show "stopped" or "running", not "unknown"
   ```

4. **Verify environment switching**:
   ```bash
   export ORACLE_SID=ORCL
   oradba_env.sh show
   # Should show ORCL info without explicit argument
   ```

## ðŸ‘¥ Contributors

- Stefan Oehrli (@oehrlis)

## ðŸ“– Support Information

- **Documentation**: [OraDBA Documentation](https://oehrlis.github.io/oradba/)
- **Plugin Standards**: [doc/plugin-standards.md](../plugin-standards.md)
- **Plugin Development**: [doc/plugin-development.md](../plugin-development.md)
- **Architecture**: [doc/architecture.md](../architecture.md)
- **Issues**: [GitHub Issues](https://github.com/oehrlis/oradba/issues)
- **Changelog**: [CHANGELOG.md](../../CHANGELOG.md)

---

**Full Changelog**: [v0.19.10...v0.20.0](https://github.com/oehrlis/oradba/compare/v0.19.10...v0.20.0)
