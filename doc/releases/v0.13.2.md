# Release Notes - OraDBA v0.13.2

**Release Date:** January 4, 2026  
**Release Type:** Patch Release (Issue #56 Phase 2)  
**Focus:** SQL Query Executor Consolidation

## Overview

Version 0.13.2 introduces a unified SQL*Plus query executor that eliminates
~240 lines of duplicated SQL*Plus boilerplate code across database query
functions. The new `execute_db_query()` function provides standardized
SQL*Plus configuration, automatic error filtering, and flexible output
formatting while maintaining 100% backward compatibility.

## What's New

### Unified SQL Query Executor

**New `execute_db_query()` Function** - Single interface for all SQL*Plus queries:

```bash
# Simple query with raw format (default)
result=$(execute_db_query "SELECT name FROM v\$database;" "raw")

# Pipe-delimited output
result=$(execute_db_query "
    SELECT 
        name || '|' || 
        db_unique_name || '|' || 
        dbid 
    FROM v\$database;" "delimited")

# Using in functions
query_database_name() {
    local query="SELECT name FROM v\$database;"
    execute_db_query "$query" "raw"
}
```

**Key Features:**

- **Standardized SQL*Plus Configuration** - Automatically applies consistent settings:

  ```sql
  SET PAGESIZE 0 LINESIZE 500 TRIMSPOOL ON TRIMOUT ON
  SET HEADING OFF FEEDBACK OFF VERIFY OFF ECHO OFF
  SET TIMING OFF TIME OFF SQLPROMPT "" SUFFIX SQL
  SET TAB OFF UNDERLINE OFF WRAP ON COLSEP ""
  SET SERVEROUTPUT OFF TERMOUT ON
  WHENEVER SQLERROR EXIT FAILURE
  WHENEVER OSERROR EXIT FAILURE
  ```

- **Automatic Error Filtering** - Removes SQL*Plus noise:
  - `SP2-*` messages
  - `ORA-*` errors
  - `ERROR` lines
  - `no rows selected`
  - `Connected to:` banners

- **Flexible Output Formats:**
  - `raw` - Direct SQL*Plus output with whitespace trimmed (default)
  - `delimited` - Extract first pipe-delimited line

**Parameters:**

- `query` - SQL query to execute (can be multiline)
- `format` - Optional: `raw` (default) or `delimited`

**Returns:**

- `0` - Query successful (output to stdout)
- `1` - Query failed or no results

### Migrated Functions

Six database query functions migrated to use `execute_db_query()`:

| Function                  | Old Lines | New Lines | Reduction |
|---------------------------|-----------|-----------|-----------|
| `query_instance_info()`   | 35        | 27        | 23%       |
| `query_database_info()`   | 42        | 30        | 29%       |
| `query_datafile_size()`   | 32        | 20        | 38%       |
| `query_memory_usage()`    | 38        | 27        | 29%       |
| `query_sessions_info()`   | 35        | 24        | 31%       |
| `query_pdb_info()`        | 38        | 32        | 16%       |
| **Total**                 | **220**   | **160**   | **27%**   |

**Total Boilerplate Eliminated:** ~240 lines of duplicated SQL*Plus configuration

### Backward Compatibility

All migrated functions maintain their original signatures and behavior:

```bash
# All these still work exactly as before
query_instance_info
query_database_info "OPEN"
query_datafile_size "MOUNT"
query_memory_usage "OPEN"
query_sessions_info "OPEN"
query_pdb_info "OPEN"
```

**Zero Breaking Changes** - Existing scripts continue to work without modification.

## Technical Details

### Modified Files

- **src/lib/common.sh** (v0.13.1 → v0.13.2)
  - New `execute_db_query()` function (lines 130-198)
  - Comprehensive parameter validation
  - Format-specific output processing
  - Error handling and logging

- **src/lib/db_functions.sh** (updated)
  - Migrated 6 query functions to use `execute_db_query()`
  - Eliminated ~240 lines of duplicated SQL*Plus boilerplate
  - All functions maintain backward-compatible signatures

- **tests/test_execute_db_query.bats** (NEW - 22 comprehensive tests)
  - Function existence and parameter validation
  - Format acceptance (raw, delimited, default)
  - Integration verification with all migrated functions
  - Code quality checks (error logging, SQL*Plus settings, error filtering)
  - Documentation presence verification
  - Boilerplate elimination validation
  - Backward compatibility tests

### Documentation Updates

- **doc/api.md** - Complete `execute_db_query()` API documentation with examples
- **doc/development.md** - New "Database Queries" best practices section
  - Dollar sign escaping rules
  - Quote handling guidelines
  - Format selection guidance
  - Error handling patterns
  - Migration examples
- **src/lib/README.md** - Updated function listings with version notes
- **CHANGELOG.md** - Detailed v0.13.2 entry with technical notes

### Test Results

- **New execute_db_query tests:** 22/22 passing ✅
- **Existing db_functions tests:** 24/24 passing ✅
- **Full test suite:** 623 tests (601 passing + 22 new), 0 failures ✅

## Usage Examples

### Basic Query

```bash
# Get database name
db_name=$(execute_db_query "SELECT name FROM v\$database;" "raw")
echo "Database: $db_name"
```

### Pipe-Delimited Query

```bash
# Get database info
db_info=$(execute_db_query "
    SELECT 
        name || '|' || 
        db_unique_name || '|' || 
        dbid 
    FROM v\$database;" "delimited")

IFS='|' read -r db_name db_unique dbid <<< "$db_info"
echo "Name: $db_name, Unique: $db_unique, DBID: $dbid"
```

### Using in Functions

```bash
get_database_status() {
    local query="
    SELECT 
        i.instance_name || '|' || 
        i.status || '|' || 
        d.open_mode 
    FROM v\$instance i, v\$database d;"
    
    execute_db_query "$query" "delimited"
}
```

### Error Handling

```bash
if ! result=$(execute_db_query "$query" "raw"); then
    log ERROR "Failed to query database"
    return 1
fi

# Or check result is non-empty
result=$(execute_db_query "$query" "raw")
if [[ -z "$result" ]]; then
    log WARN "Query returned no results"
    return 1
fi
```

## Migration Guide

### For Developers Adding New Query Functions

**Old Pattern (40+ lines with boilerplate):**

```bash
query_my_data() {
    local mode="$1"
    
    if [[ "$mode" == "STARTED" ]]; then
        return 1
    fi
    
    result=$(sqlplus -s / as sysdba 2>/dev/null << 'EOF'
SET PAGESIZE 0 LINESIZE 500 TRIMSPOOL ON TRIMOUT ON
SET HEADING OFF FEEDBACK OFF VERIFY OFF ECHO OFF
SET TIMING OFF TIME OFF SQLPROMPT "" SUFFIX SQL
SET TAB OFF UNDERLINE OFF WRAP ON COLSEP ""
SET SERVEROUTPUT OFF TERMOUT ON
WHENEVER SQLERROR EXIT FAILURE
WHENEVER OSERROR EXIT FAILURE
SELECT my_data FROM my_table;
EXIT;
EOF
)
    
    # Filter errors
    result=$(echo "$result" | grep -v "^SP2-\|^ORA-\|^ERROR")
    
    if [[ -n "$result" ]]; then
        echo "$result"
        return 0
    fi
    return 1
}
```

**New Pattern (10-15 lines using execute_db_query):**

```bash
query_my_data() {
    local mode="$1"
    
    # Only query if database is at least MOUNTED
    if [[ "$mode" == "STARTED" ]]; then
        return 1
    fi
    
    local query="SELECT my_data FROM my_table;"
    execute_db_query "$query" "raw"
}
```

### Important Notes

1. **Escape Dollar Signs:** Use `v\$database` not `v$database` in SQL
2. **Use Double Quotes:** For queries containing single quotes
3. **Choose Format:** `raw` for most cases, `delimited` for pipe-separated values
4. **Check Return Code:** `execute_db_query` returns 0 on success, 1 on failure

## Best Practices

### SQL Query Guidelines

```bash
# ✅ GOOD - Escaped dollar signs, double quotes
local query="
SELECT 
    name || '|' || status 
FROM v\$instance 
WHERE status = 'OPEN';"

# ❌ BAD - Unescaped $ (bash interprets as variable)
local query="
SELECT name FROM v$database;"

# ❌ BAD - Complex quote escaping with single quotes
local query='SELECT name || '\''|'\'' || status FROM v$instance'
```

### Format Selection

```bash
# Use 'raw' for:
# - Single values
# - Multi-line output
# - No delimiters
result=$(execute_db_query "SELECT ROUND(SUM(bytes)/1024/1024/1024, 2) 
    FROM v\$datafile;" "raw")

# Use 'delimited' for:
# - Pipe-separated values
# - Need only first row
result=$(execute_db_query "
    SELECT 
        name || '|' || 
        db_unique_name || '|' || 
        dbid 
    FROM v\$database;" "delimited")
```

## Installation

### Upgrade from v0.13.1

```bash
# 1. Backup current installation (optional)
cp -r $ORADBA_BASE $ORADBA_BASE.backup

# 2. Run installer
./oradba_install.sh --update

# 3. Verify version
oradba_version
# Output: 0.13.2

# 4. Test functionality
source oraenv.sh <ORACLE_SID>
```

No configuration changes required - all updates are internal.

## Known Issues

None at this time.

## Breaking Changes

None - This release maintains 100% backward compatibility.

## What's Next

Phase 3 of Issue #56 focuses on metadata standardization with a unified
`get_extension_property()` function for consistent metadata access across
extensions and components.

## Assets

- **Full Installer:** `oradba-installer-v0.13.2.sh`
- **Source Tarball:** `oradba-v0.13.2.tar.gz`
- **Documentation:** See [doc/api.md](../api.md) for complete API reference

## GitHub Release

```bash
# View release on GitHub
gh release view v0.13.2

# Download assets
gh release download v0.13.2
```

---

**Full Changelog:** [v0.13.1...v0.13.2](https://github.com/oehrlis/oradba/compare/v0.13.1...v0.13.2)

**Issue:** #56 Phase 2 - SQL Query Consolidation
