# Release Notes - OraDBA v0.13.3

**Release Date:** January 4, 2026  
**Release Type:** Patch Release (Issue #56 Phase 3)  
**Focus:** Extension Metadata Standardization

## Overview

Version 0.13.3 introduces a unified extension property accessor that eliminates
~69 lines of duplicated metadata access code across extension management
functions. The new `get_extension_property()` function provides standardized
property retrieval with configuration override support, metadata file parsing,
and fallback values while maintaining 100% backward compatibility.

## What's New

### Unified Extension Property Accessor

**New `get_extension_property()` Function** - Single interface for all extension metadata access:

```bash
# Get extension name with directory fallback
ext_name=$(get_extension_property "/opt/extensions/myext" "name" "myext")

# Get version with "unknown" fallback
ext_version=$(get_extension_property "/opt/extensions/myext" "version" "unknown")

# Get priority with config override support
ext_priority=$(get_extension_property "/opt/extensions/myext" "priority" "50" "true")

# Check if extension is enabled (with config override)
enabled=$(get_extension_property "/opt/extensions/myext" "enabled" "true" "true")
[[ "$enabled" == "true" ]] && echo "Extension enabled"

# Get custom property
custom_value=$(get_extension_property "/opt/extensions/myext" "custom_field")
```

**Key Features:**

- **Property Precedence** - Automatically checks in order:

  1. **Environment variable override** (if `check_config=true`):
     - `ORADBA_EXT_<NAME>_<PROPERTY>` environment variables
     - Example: `ORADBA_EXT_MYEXTENSION_PRIORITY="10"`
  2. **Extension metadata file** (`.extension`):
     - YAML-like key-value format
     - Standard properties: name, version, description, priority, enabled
  3. **Fallback value** (if provided)
  4. **Empty string** (if no value found)

- **Configuration Override Support** - Enable/disable via `check_config` parameter:

  ```bash
  # Without config override (default)
  value=$(get_extension_property "/path/to/ext" "priority" "50")
  
  # With config override (checks ORADBA_EXT_* env var)
  value=$(get_extension_property "/path/to/ext" "priority" "50" "true")
  ```

- **Flexible Metadata Access:**
  - Standard properties (name, version, description, priority, enabled)
  - Custom properties (any key in `.extension` file)
  - Automatic fallback handling

**Parameters:**

- `ext_path` - Path to extension directory
- `property` - Property name to retrieve
- `fallback` - Optional fallback value if property not found (default: empty)
- `check_config` - Optional "true" to check environment variable override

**Returns:**

- Property value string to stdout
- Empty string if not found and no fallback provided

**Extension Metadata File Format:**

```yaml
# .extension file (YAML-like key-value)
name: my_extension
version: 1.0.0
description: Custom extension for special features
priority: 30
enabled: true
custom_field: custom_value
```

### Migrated Functions

Five extension metadata functions migrated to use `get_extension_property()`:

| Function                      | Old Lines | New Lines | Reduction |
|-------------------------------|-----------|-----------|-----------|
| `get_extension_name()`        | 18        | 5         | 72%       |
| `get_extension_version()`     | 11        | 3         | 73%       |
| `get_extension_description()` | 7         | 3         | 57%       |
| `get_extension_priority()`    | 17        | 3         | 82%       |
| `is_extension_enabled()`      | 16        | 4         | 75%       |
| **Total**                     | **69**    | **18**    | **74%**   |

**Total Boilerplate Eliminated:** ~69 lines of duplicated metadata access logic

### Backward Compatibility

All migrated functions maintain their original signatures and behavior:

```bash
# All these still work exactly as before
ext_name=$(get_extension_name "/opt/extensions/myext")
ext_version=$(get_extension_version "/opt/extensions/myext")
ext_desc=$(get_extension_description "/opt/extensions/myext")
ext_priority=$(get_extension_priority "/opt/extensions/myext")
is_extension_enabled "myext" "/opt/extensions/myext" && echo "Enabled"
```

**Internally**, each function now calls `get_extension_property()`:

```bash
# Example: get_extension_name implementation
get_extension_name() {
    local ext_path="${1:?Extension path required}"
    get_extension_property "${ext_path}" "name" "$(basename "${ext_path}")"
}
```

### Configuration Override Examples

**Override extension priority:**

```bash
# Set environment variable
export ORADBA_EXT_MYEXTENSION_PRIORITY="10"

# Get priority (will use environment variable)
priority=$(get_extension_priority "/opt/extensions/myextension")
echo "$priority"  # Output: 10 (from env var, not metadata file)
```

**Disable extension via configuration:**

```bash
# Set environment variable
export ORADBA_EXT_MYEXTENSION_ENABLED="false"

# Check if enabled
if is_extension_enabled "myextension" "/opt/extensions/myextension"; then
    echo "Extension enabled"
else
    echo "Extension disabled"  # This will execute
fi
```

**Override multiple properties:**

```bash
export ORADBA_EXT_CUSTOMEXT_PRIORITY="5"
export ORADBA_EXT_CUSTOMEXT_ENABLED="true"
export ORADBA_EXT_CUSTOMEXT_VERSION="2.0.0-override"

# All properties will use environment variable values
```

## Testing

### Test Coverage

**42 Extension Tests** in `tests/test_extensions.bats` (all passing):

- **33 Existing Tests** - Backward compatibility verification
  - Extension discovery and validation
  - Metadata parsing
  - Extension loading and initialization
  - Priority ordering
  - All original functionality preserved

- **9 New Tests** - `get_extension_property()` specific:
  - Function existence verification
  - Metadata property reading (name, version, custom fields)
  - Fallback behavior (with and without values)
  - Config override handling (enabled/disabled modes)
  - Precedence verification (config > metadata > fallback)
  - Migration verification (confirms functions use new implementation)

### Test Results

```bash
$ bats tests/test_extensions.bats
✓ Extension tests (33 existing + 9 new)
42 tests, 0 failures
```

**No regressions** - Full test suite (600+ tests) shows 0 failures.

## Migration Impact

### Code Quality Improvements

1. **Code Reduction:**
   - Eliminated 69 lines of duplicated metadata access logic
   - 74% reduction across 5 functions
   - Single source of truth for property retrieval

2. **Maintainability:**
   - Centralized metadata access logic
   - Easier to add new properties
   - Consistent behavior across all functions

3. **Flexibility:**
   - Configuration override support
   - Custom property support
   - Fallback value support

### Breaking Changes

**None** - All functions maintain backward-compatible signatures and behavior.

### Deprecations

**None** - All existing functions remain available and functional.

## Documentation Updates

### API Documentation

Updated [`doc/api.md`](../api.md) with comprehensive documentation:

- `get_extension_property()` function reference
- Parameter descriptions and examples
- Property precedence explanation
- Configuration override patterns
- Convenience wrapper function documentation

### Usage Examples

See the **Examples** section above for common usage patterns.

## Technical Details

### Implementation

**File:** `src/lib/extensions.sh`  
**Lines:** 104-142 (39 lines including documentation)  
**Function Signature:**

```bash
get_extension_property() {
    local ext_path="$1"
    local property="$2"
    local fallback="${3:-}"
    local check_config="${4:-false}"
    # ... implementation ...
}
```

**Precedence Logic:**

1. Check `ORADBA_EXT_<NAME>_<PROPERTY>` environment variable (if enabled)
2. Parse `.extension` metadata file
3. Use fallback value (if provided)
4. Return empty string

### Performance

- **Negligible impact** - Single function call overhead
- **Reduced overhead** - Less code execution per metadata access
- **Cached metadata** - Metadata file read once per property access

## Upgrade Guide

### For Users

**No action required** - All functionality remains backward compatible.

**Optional:** Configure overrides via environment variables:

```bash
# Add to your .bashrc or profile
export ORADBA_EXT_MYEXT_PRIORITY="10"
export ORADBA_EXT_MYEXT_ENABLED="false"
```

### For Extension Developers

**Recommended:** Use `get_extension_property()` for custom metadata access:

```bash
# In your extension code
custom_value=$(get_extension_property "$EXTENSION_PATH" "custom_setting" "default_value")
```

**Best Practice:** Define metadata in `.extension` file:

```yaml
name: my_extension
version: 1.0.0
description: My custom extension
priority: 50
enabled: true
custom_setting: custom_value
custom_flag: true
```

## Related Changes

### Issue #56 Progress

This release completes **Phase 3** of Issue #56 (OraDBA Refactoring):

- ✅ **Phase 1**: Version Management (v0.13.1)
- ✅ **Phase 2**: SQL Query Executor (v0.13.2)
- ✅ **Phase 3**: Extension Metadata Standardization (v0.13.3)
- ⏳ **Phase 4**: Alias Generation Refactoring
- ⏳ **Phase 5**: Configuration Loading
- ⏳ **Phase 6**: Cleanup & Final Documentation

### Upcoming Releases

- **v0.13.4**: Alias generation refactoring (Phase 4)
- **v0.13.5**: Configuration loading improvements (Phase 5)
- **v0.14.0**: Final cleanup and documentation (Phase 6)

## Contributors

- Stefan Oehrli (@oehrlis)

## Links

- **Issue:** [#56 - OraDBA Refactoring](https://github.com/oehrlis/oradba/issues/56)
- **Milestone:** [v0.13.x - Incremental Refactoring](https://github.com/oehrlis/oradba/milestone/3)
- **Previous Release:** [v0.13.2](v0.13.2.md)
- **Documentation:** [API Reference](../api.md#extension-functions)

---

**Full Changelog:** [v0.13.2...v0.13.3](https://github.com/oehrlis/oradba/compare/v0.13.2...v0.13.3)
