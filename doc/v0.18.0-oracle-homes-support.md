# OraDBA v0.18.0 - Oracle Homes Support (Beyond Databases)

**Feature:** Support for non-database Oracle products  
**Target Version:** 0.18.0  
**Status:** Planning  
**Date:** January 9, 2026

## Overview

Extend OraDBA to support Oracle products beyond just Database homes:

- Oracle Unified Directory (OUD)
- Oracle Data Safe On-Premises Connector
- Oracle Client installations
- Future: WebLogic, OMS, EM Agent, etc.

## Requirements Summary

Based on user input:

1. **Discovery:** Hybrid - auto-detect under `$ORACLE_BASE/product/*` + manual registration
2. **Storage:** `${ORADBA_BASE}/etc/oradba_homes.conf`
3. **Environment:** Unified `source oraenv.sh <NAME>` (auto-detects type)
4. **Variables:** Set `ORACLE_HOME`, `ORACLE_INSTANCE` (product-dependent)
5. **Aliases:** Reuse existing `cdh` (cd to current ORACLE_HOME)
6. **Display:** Extend `oraup.sh` to show both databases and homes
7. **Coexistence:** Maintain separate from BasEnv (no overlap)
8. **Metadata:** Simple format - name, path, type, ordering

### Product-Specific Notes

**Oracle Unified Directory:**

- One ORACLE_HOME can support multiple OUD instances
- ORACLE_INSTANCE points to specific instance directory
- Typical structure: `/u01/app/oracle/product/oud12c` (home), `/u01/app/oracle/oud_instances/oud1` (instance)

**Data Safe On-Premises Connector:**

- Oracle Connection Manager based
- Typically one connector per home
- Simpler structure than OUD

## Architecture

### 1. File Structure

#### New Configuration File: `${ORADBA_BASE}/etc/oradba_homes.conf`

**Format:**

```bash
# Oracle Homes Configuration
# Format: NAME:ORACLE_HOME:PRODUCT_TYPE:ORDER[:DESCRIPTION]
#
# NAME          - Identifier (uppercase recommended)
# ORACLE_HOME   - Path to Oracle home directory
# PRODUCT_TYPE  - Product type (oud, datasafe, client, weblogic, oms, emagent)
# ORDER         - Display order (lower numbers first, 10-based increments)
# DESCRIPTION   - Optional description
#
# Examples:
OUD12C:/u01/app/oracle/product/oud12c:oud:10:Oracle Unified Directory 12c
DATASAFE:/u01/app/oracle/product/datasafe:datasafe:20:Data Safe Connector
CLIENT19:/opt/oracle/product/19c/client:client:30:Oracle Client 19c
```

**Characteristics:**

- Colon-delimited (matches oratab pattern)
- Comment lines start with `#`
- Empty lines ignored
- Case-sensitive names
- Optional description field

### 2. Core Functions (common.sh)

#### New Functions

```bash
# Parse oradba_homes.conf and return home details
# Usage: parse_oracle_home <NAME>
# Returns: NAME:ORACLE_HOME:PRODUCT_TYPE:ORDER:DESCRIPTION
parse_oracle_home() {
    local name=$1
    local homes_file="${ORADBA_BASE}/etc/oradba_homes.conf"
    
    [[ -f "$homes_file" ]] || return 1
    
    grep -v "^#" "$homes_file" | grep -v "^[[:space:]]*$" | \
        grep "^${name}:" | head -1
}

# Get list of all registered homes
# Returns: One NAME per line
list_oracle_homes() {
    local homes_file="${ORADBA_BASE}/etc/oradba_homes.conf"
    
    [[ -f "$homes_file" ]] || return 0
    
    grep -v "^#" "$homes_file" | grep -v "^[[:space:]]*$" | \
        cut -d: -f1
}

# Detect product type from ORACLE_HOME
# Usage: detect_product_type <ORACLE_HOME>
# Returns: product type string or "unknown"
detect_product_type() {
    local oracle_home=$1
    
    [[ ! -d "$oracle_home" ]] && { echo "unknown"; return 1; }
    
    # OUD detection
    if [[ -f "$oracle_home/oud/bin/oud" || -f "$oracle_home/bin/dsreplication" ]]; then
        echo "oud"
        return 0
    fi
    
    # Data Safe / Connection Manager
    if [[ -f "$oracle_home/bin/cmctl" || -d "$oracle_home/datasafe" ]]; then
        echo "datasafe"
        return 0
    fi
    
    # Oracle Client
    if [[ ! -f "$oracle_home/bin/sqlplus" ]] && [[ -d "$oracle_home/network" ]]; then
        echo "client"
        return 0
    fi
    
    # WebLogic
    if [[ -f "$oracle_home/wlserver/server/lib/weblogic.jar" ]]; then
        echo "weblogic"
        return 0
    fi
    
    # OMS (Enterprise Manager)
    if [[ -d "$oracle_home/oms" || -f "$oracle_home/bin/emctl" ]]; then
        echo "oms"
        return 0
    fi
    
    # EM Agent
    if [[ -d "$oracle_home/agent_inst" || -f "$oracle_home/bin/emctl" ]]; then
        echo "emagent"
        return 0
    fi
    
    # Database (fallback)
    if [[ -f "$oracle_home/bin/sqlplus" && -f "$oracle_home/bin/oracle" ]]; then
        echo "rdbms"
        return 0
    fi
    
    echo "unknown"
    return 1
}

# Check if name exists in oratab or oradba_homes.conf
# Usage: is_oracle_home <NAME>
# Returns: 0 if found, 1 if not
is_oracle_home() {
    local name=$1
    
    # Check oratab first (databases)
    parse_oratab "$name" >/dev/null 2>&1 && return 0
    
    # Check homes config
    parse_oracle_home "$name" >/dev/null 2>&1 && return 0
    
    return 1
}

# Get ORACLE_HOME for any type (database or other)
# Usage: get_oracle_home <NAME>
# Returns: ORACLE_HOME path
get_oracle_home() {
    local name=$1
    local result
    
    # Try oratab first (databases)
    result=$(parse_oratab "$name" 2>/dev/null | cut -d: -f2)
    [[ -n "$result" ]] && { echo "$result"; return 0; }
    
    # Try homes config
    result=$(parse_oracle_home "$name" 2>/dev/null | cut -d: -f2)
    [[ -n "$result" ]] && { echo "$result"; return 0; }
    
    return 1
}
```

### 3. Enhanced oraenv.sh

#### Updated Logic

```bash
# Current behavior: Only checks oratab
# New behavior: Check oratab first, then oradba_homes.conf

_oraenv_set_environment() {
    local sid=$1
    local oratab_entry
    local home_entry
    local oracle_home
    local product_type
    
    # Try oratab first (database)
    oratab_entry=$(parse_oratab "$sid" 2>/dev/null)
    if [[ -n "$oratab_entry" ]]; then
        oracle_home=$(echo "$oratab_entry" | cut -d: -f2)
        product_type="rdbms"
        export ORACLE_SID="$sid"
    else
        # Try oracle homes config
        home_entry=$(parse_oracle_home "$sid" 2>/dev/null)
        if [[ -n "$home_entry" ]]; then
            oracle_home=$(echo "$home_entry" | cut -d: -f2)
            product_type=$(echo "$home_entry" | cut -d: -f3)
            unset ORACLE_SID  # Not a database
        else
            log_error "Neither database nor Oracle home found: $sid"
            return 1
        fi
    fi
    
    # Set ORACLE_HOME
    export ORACLE_HOME="$oracle_home"
    
    # Product-specific environment
    case "$product_type" in
        rdbms)
            # Existing database logic
            _oraenv_set_database_environment "$sid" "$oracle_home"
            ;;
        oud)
            _oraenv_set_oud_environment "$sid" "$oracle_home"
            ;;
        datasafe)
            _oraenv_set_datasafe_environment "$sid" "$oracle_home"
            ;;
        *)
            _oraenv_set_generic_environment "$sid" "$oracle_home"
            ;;
    esac
}

# Product-specific environment functions
_oraenv_set_oud_environment() {
    local name=$1
    local oracle_home=$2
    
    export ORACLE_HOME="$oracle_home"
    export PATH="$oracle_home/bin:$PATH"
    
    # OUD instances under ORACLE_BASE/oud_instances/<name> (common pattern)
    if [[ -n "$ORACLE_BASE" && -d "$ORACLE_BASE/oud_instances/$name" ]]; then
        export ORACLE_INSTANCE="$ORACLE_BASE/oud_instances/$name"
    fi
    
    log_info "Oracle Unified Directory environment set: $name"
}

_oraenv_set_datasafe_environment() {
    local name=$1
    local oracle_home=$2
    
    export ORACLE_HOME="$oracle_home"
    export PATH="$oracle_home/bin:$PATH"
    
    # Data Safe specific (if needed)
    if [[ -d "$oracle_home/datasafe" ]]; then
        export DATASAFE_HOME="$oracle_home/datasafe"
    fi
    
    log_info "Data Safe Connector environment set: $name"
}

_oraenv_set_generic_environment() {
    local name=$1
    local oracle_home=$2
    
    export ORACLE_HOME="$oracle_home"
    export PATH="$oracle_home/bin:$PATH"
    
    log_info "Oracle home environment set: $name"
}
```

### 4. Enhanced oraup.sh

#### Display Both Databases and Homes

```bash
# Current: Only show databases from oratab
# New: Show databases AND other Oracle homes

main() {
    local show_databases=true
    local show_homes=true
    
    # Parse arguments
    case "$1" in
        --db|--databases)
            show_homes=false
            ;;
        --homes)
            show_databases=false
            ;;
    esac
    
    # Show databases
    if [[ "$show_databases" == "true" ]]; then
        echo "Oracle Databases:"
        echo "================="
        # Existing database listing logic
        list_databases
        echo
    fi
    
    # Show Oracle homes
    if [[ "$show_homes" == "true" ]] && [[ -f "${ORADBA_BASE}/etc/oradba_homes.conf" ]]; then
        echo "Oracle Homes:"
        echo "============="
        list_oracle_homes_display
        echo
    fi
}

list_oracle_homes_display() {
    local homes_file="${ORADBA_BASE}/etc/oradba_homes.conf"
    local name oracle_home product_type order description
    
    [[ ! -f "$homes_file" ]] && return 0
    
    # Read and sort by ORDER field
    grep -v "^#" "$homes_file" | grep -v "^[[:space:]]*$" | \
        sort -t: -k4 -n | \
        while IFS=: read -r name oracle_home product_type order description; do
            printf "  %-12s %-40s %-10s\n" "$name" "$oracle_home" "($product_type)"
            [[ -n "$description" ]] && printf "               %s\n" "$description"
        done
}
```

#### Example Output

```bash
$ oraup.sh

Oracle Databases:
=================
  FREE         /opt/oracle/product/26ai/dbhomeFree    OPEN
  TESTDB       /opt/oracle/product/19c/dbhome_1       MOUNT

Oracle Homes:
=============
  OUD12C       /u01/app/oracle/product/oud12c         (oud)
               Oracle Unified Directory 12c
  DATASAFE     /u01/app/oracle/product/datasafe       (datasafe)
               Data Safe On-Premises Connector
  CLIENT19     /opt/oracle/product/19c/client         (client)
               Oracle Client 19c
```

### 5. New Command: oradba_home.sh

#### Purpose

Manage Oracle homes registration and detection.

#### Commands

```bash
oradba_home.sh add <NAME> <ORACLE_HOME> <PRODUCT_TYPE> [ORDER] [DESCRIPTION]
oradba_home.sh list
oradba_home.sh detect [--scan-path PATH]
oradba_home.sh remove <NAME>
oradba_home.sh show <NAME>
oradba_home.sh validate
```

#### Implementation Outline

```bash
#!/usr/bin/env bash
# oradba_home.sh - Oracle Homes Management
# Manage non-database Oracle homes

cmd_add() {
    local name=$1
    local oracle_home=$2
    local product_type=$3
    local order=${4:-50}
    local description=$5
    
    # Validation
    [[ -z "$name" ]] && { log_error "Name required"; return 1; }
    [[ -z "$oracle_home" ]] && { log_error "ORACLE_HOME required"; return 1; }
    [[ ! -d "$oracle_home" ]] && { log_error "ORACLE_HOME not found: $oracle_home"; return 1; }
    
    # Auto-detect product type if not specified
    if [[ -z "$product_type" ]]; then
        product_type=$(detect_product_type "$oracle_home")
        log_info "Auto-detected product type: $product_type"
    fi
    
    # Add to config
    local homes_file="${ORADBA_BASE}/etc/oradba_homes.conf"
    local entry="${name}:${oracle_home}:${product_type}:${order}"
    [[ -n "$description" ]] && entry="${entry}:${description}"
    
    # Create file if doesn't exist
    if [[ ! -f "$homes_file" ]]; then
        cat > "$homes_file" <<EOF
# Oracle Homes Configuration
# Format: NAME:ORACLE_HOME:PRODUCT_TYPE:ORDER[:DESCRIPTION]
EOF
    fi
    
    # Remove existing entry if present
    sed -i.bak "/^${name}:/d" "$homes_file"
    
    # Add new entry
    echo "$entry" >> "$homes_file"
    
    log_info "Added Oracle home: $name"
}

cmd_detect() {
    local scan_path="${1:-$ORACLE_BASE/product}"
    local detected=0
    
    log_info "Scanning for Oracle homes in: $scan_path"
    
    [[ ! -d "$scan_path" ]] && { log_error "Path not found: $scan_path"; return 1; }
    
    # Scan directories
    find "$scan_path" -maxdepth 2 -type d -name "bin" | while read -r bin_dir; do
        local oracle_home="${bin_dir%/bin}"
        local product_type
        
        product_type=$(detect_product_type "$oracle_home")
        
        if [[ "$product_type" != "unknown" && "$product_type" != "rdbms" ]]; then
            local name=$(basename "$oracle_home" | tr '[:lower:]' '[:upper:]')
            
            # Check if already registered
            if ! parse_oracle_home "$name" >/dev/null 2>&1; then
                echo "Found: $oracle_home ($product_type)"
                read -p "Register as '$name'? [Y/n] " -n 1 -r
                echo
                if [[ $REPLY =~ ^[Yy]$ ]] || [[ -z $REPLY ]]; then
                    cmd_add "$name" "$oracle_home" "$product_type" "$((++detected * 10))"
                fi
            fi
        fi
    done
    
    log_info "Detection complete. Found $detected homes."
}

cmd_list() {
    local homes_file="${ORADBA_BASE}/etc/oradba_homes.conf"
    
    [[ ! -f "$homes_file" ]] && { log_info "No Oracle homes registered"; return 0; }
    
    echo "Registered Oracle Homes:"
    echo "========================"
    
    grep -v "^#" "$homes_file" | grep -v "^[[:space:]]*$" | \
        sort -t: -k4 -n | \
        while IFS=: read -r name oracle_home product_type order description; do
            printf "%-15s %-50s %-10s\n" "$name" "$oracle_home" "($product_type)"
            [[ -n "$description" ]] && printf "                %s\n" "$description"
        done
}

cmd_remove() {
    local name=$1
    local homes_file="${ORADBA_BASE}/etc/oradba_homes.conf"
    
    [[ -z "$name" ]] && { log_error "Name required"; return 1; }
    [[ ! -f "$homes_file" ]] && { log_error "No homes registered"; return 1; }
    
    # Check if exists
    parse_oracle_home "$name" >/dev/null 2>&1 || {
        log_error "Home not found: $name"
        return 1
    }
    
    # Remove entry
    sed -i.bak "/^${name}:/d" "$homes_file"
    
    log_info "Removed Oracle home: $name"
}

cmd_validate() {
    local homes_file="${ORADBA_BASE}/etc/oradba_homes.conf"
    local errors=0
    
    [[ ! -f "$homes_file" ]] && { log_info "No Oracle homes to validate"; return 0; }
    
    echo "Validating Oracle Homes:"
    echo "========================"
    
    grep -v "^#" "$homes_file" | grep -v "^[[:space:]]*$" | \
        while IFS=: read -r name oracle_home product_type order description; do
            printf "%-15s " "$name"
            
            if [[ ! -d "$oracle_home" ]]; then
                echo "✗ ORACLE_HOME not found: $oracle_home"
                ((errors++))
            elif [[ ! -d "$oracle_home/bin" ]]; then
                echo "✗ Missing bin directory"
                ((errors++))
            else
                echo "✓ Valid"
            fi
        done
    
    echo
    [[ $errors -eq 0 ]] && log_info "All homes valid" || log_error "$errors homes invalid"
}
```

### 6. Auto-Detection Strategy

#### During Installation

Add detection phase to `oradba_install.sh`:

```bash
# After installation completes
if [[ -n "$ORACLE_BASE" && -d "$ORACLE_BASE/product" ]]; then
    echo "Scanning for Oracle homes..."
    "${ORADBA_PREFIX}/bin/oradba_home.sh" detect --auto --scan-path "$ORACLE_BASE/product"
fi
```

#### Manual Scan

Users can trigger detection:

```bash
# Scan default location
oradba_home.sh detect

# Scan custom path
oradba_home.sh detect --scan-path /opt/oracle/middleware

# Auto-register all found homes (non-interactive)
oradba_home.sh detect --auto
```

### 7. Product-Specific Considerations

#### Oracle Unified Directory (OUD)

**Environment Variables:**

- `ORACLE_HOME` - OUD installation
- `ORACLE_INSTANCE` - Specific OUD instance (if applicable)
- `PATH` - Include `$ORACLE_HOME/bin`

**Typical Commands:**

- `dsconfig` - Directory service configuration
- `dsreplication` - Replication management
- `oud-setup` - Instance setup

**Instance Detection:**
Check common locations:

- `$ORACLE_BASE/oud_instances/<name>`
- `$ORACLE_HOME/asinst_<name>`

#### Data Safe On-Premises Connector

**Environment Variables:**

- `ORACLE_HOME` - Data Safe installation
- `PATH` - Include `$ORACLE_HOME/bin`
- `DATASAFE_HOME` - Data Safe specific (if exists)

**Typical Commands:**

- `cmctl` - Connection Manager control
- Connection Manager admin commands

### 8. Validation & Testing

#### Test Scenarios

1. **Basic Registration:**

   ```bash
   oradba_home.sh add OUD12C /u01/app/oracle/product/oud12c oud 10 "OUD 12c"
   source oraenv.sh OUD12C
   echo $ORACLE_HOME  # Should show OUD home
   ```

2. **Environment Switching:**

   ```bash
   source oraenv.sh FREE       # Database
   echo $ORACLE_SID            # Shows FREE
   source oraenv.sh OUD12C     # OUD
   echo $ORACLE_SID            # Empty (not a DB)
   echo $ORACLE_HOME           # Shows OUD home
   ```

3. **Display Integration:**

   ```bash
   oraup.sh                    # Shows both DBs and homes
   oraup.sh --db               # Shows only DBs
   oraup.sh --homes            # Shows only homes
   ```

4. **Auto-Detection:**

   ```bash
   oradba_home.sh detect       # Interactive detection
   oradba_home.sh list         # Show detected homes
   ```

#### Test Matrix

| Test               | Database | OUD | Data Safe | Client |
|--------------------|----------|-----|-----------|--------|
| Register manually  | ✓        | ✓   | ✓         | ✓      |
| Auto-detect        | N/A      | ✓   | ✓         | ✓      |
| Environment switch | ✓        | ✓   | ✓         | ✓      |
| Display in oraup   | ✓        | ✓   | ✓         | ✓      |
| cdh alias works    | ✓        | ✓   | ✓         | ✓      |
| Product detection  | ✓        | ✓   | ✓         | ✓      |

### 9. Documentation Requirements

#### User Documentation Updates

1. **Installation Guide** (02-installation.md)
   - Post-installation home detection
   - Manual registration examples

2. **Quick Start Guide** (03-quickstart.md)
   - Switching to non-database homes
   - OUD and Data Safe examples

3. **Environment Management** (04-environment.md)
   - Oracle homes concept
   - Product-specific variables

4. **New Chapter** - Oracle Homes (new file)
   - Comprehensive home management
   - Product-specific guides
   - OUD instance management
   - Data Safe connector setup

5. **Reference Guide** (13-reference.md)
   - oradba_home.sh commands
   - Updated oraup.sh options

#### Examples to Include

```bash
# Register OUD home
oradba_home.sh add OUD12C /u01/app/oracle/product/oud12c oud 10

# Switch to OUD environment
source oraenv.sh OUD12C

# Work with OUD
dsconfig --help
cd $ORACLE_HOME

# Register Data Safe
oradba_home.sh add DATASAFE /opt/oracle/product/datasafe datasafe 20

# Switch to Data Safe
source oraenv.sh DATASAFE

# View all homes
oraup.sh
```

### 10. Implementation Phases

#### Phase 1: Core Infrastructure (Week 1)

- [ ] Add `oradba_homes.conf` format
- [ ] Implement `common.sh` functions
- [ ] Create `oradba_home.sh` skeleton
- [ ] Basic add/list/remove commands
- [ ] Unit tests for parsing functions

#### Phase 2: Detection & Integration (Week 2)

- [ ] Implement product detection logic
- [ ] Add auto-detection to `oradba_home.sh`
- [ ] Enhance `oraenv.sh` for home types
- [ ] Product-specific environment functions
- [ ] Integration tests

#### Phase 3: Display & UX (Week 3)

- [ ] Update `oraup.sh` to show homes
- [ ] Add filtering options (--db, --homes)
- [ ] Color-coded output
- [ ] Validation command
- [ ] User acceptance testing

#### Phase 4: Documentation (Week 4)

- [ ] Update existing documentation
- [ ] Create Oracle Homes guide
- [ ] Add product-specific examples
- [ ] Update reference guide
- [ ] Create tutorial videos/screenshots

#### Phase 5: Testing & Release

- [ ] Comprehensive test suite
- [ ] Manual testing with real OUD/Data Safe
- [ ] Performance testing
- [ ] Documentation review
- [ ] Release v0.18.0

### 11. Backward Compatibility

**No Breaking Changes:**

- Existing `oraenv.sh <SID>` behavior unchanged
- Databases still use oratab exclusively
- New homes file is optional
- `oraup.sh` shows databases by default

**Graceful Degradation:**

- If `oradba_homes.conf` doesn't exist, skip home display
- If detection fails, log warning but continue
- Unknown product types handled gracefully

### 12. Future Enhancements (v0.19.0+)

**Potential Features:**

- [ ] Instance management for OUD (multiple instances per home)
- [ ] WebLogic domain support
- [ ] EM Agent registration
- [ ] Product-specific aliases (beyond cdh)
- [ ] Health checks per product type
- [ ] BasEnv orahometab/sidtab import/sync
- [ ] Cluster/RAC awareness for homes
- [ ] Export/import home configurations

### 13. Success Criteria

**Must Have:**

- ✓ Register OUD and Data Safe homes manually
- ✓ Switch environment with `source oraenv.sh <NAME>`
- ✓ Display homes in `oraup.sh`
- ✓ Auto-detect homes under `$ORACLE_BASE/product`
- ✓ No impact on existing database functionality

**Should Have:**

- ✓ Validate registered homes
- ✓ Product-specific environment variables
- ✓ Order-based display
- ✓ Comprehensive documentation

**Nice to Have:**

- Interactive detection wizard
- Product-specific helpers
- Integration with oradba_validate.sh
- Tab completion for home names

---

## Next Steps

1. **Review & Approval:** Validate this design with stakeholders
2. **Prototype:** Create proof-of-concept with basic add/list
3. **Iterate:** Refine based on feedback
4. **Implement:** Follow phased approach
5. **Test:** Comprehensive testing with real products
6. **Document:** Complete user documentation
7. **Release:** v0.18.0 with Oracle Homes support

---

**Questions or Feedback?**

Please review and provide feedback on:

- File format and parsing approach
- Detection logic for each product type
- Environment variable naming
- Display format in oraup.sh
- Command structure for oradba_home.sh

---

*Document Version: 1.0*  
*Last Updated: January 9, 2026*  
*Author: Stefan Oehrli*
