# ------------------------------------------------------------------------------
# OraDBA - Oracle Database Infrastructure and Security, 5630 Muri, Switzerland
# ------------------------------------------------------------------------------
# Name.......: oradba_core.conf
# Author.....: Stefan Oehrli (oes) stefan.oehrli@oradba.ch
# Editor.....: Stefan Oehrli
# Date.......: 2025.12.18
# Revision...: 0.7.5
# Purpose....: Core system configuration for OraDBA (paths, installation, behavior)
# Notes......: Read-only core config. Override in oradba_customer.conf or sid.*.conf
# Reference..: https://github.com/oehrlis/oradba
# License....: Apache License Version 2.0, January 2004 as shown
#              at http://www.apache.org/licenses/
# ------------------------------------------------------------------------------
# shellcheck shell=bash disable=SC2034
# Config file defines variables for consumers; unused warnings are expected.

# ------------------------------------------------------------------------------
# Core System Settings
# ------------------------------------------------------------------------------

# Installation prefix (base directory for OraDBA installation)
export ORADBA_PREFIX="${ORADBA_PREFIX:-/opt/oradba}"

# Local base directory (parent of ORADBA_PREFIX, similar to TVD_BASE)
# Auto-detected from ORACLE_BASE/local or parent of ORADBA_PREFIX
# Examples:
#   ORADBA_PREFIX=/opt/oradba            → ORADBA_LOCAL_BASE=/opt
#   ORADBA_PREFIX=/opt/oracle/local/oradba → ORADBA_LOCAL_BASE=/opt/oracle/local
if [[ -z "${ORADBA_LOCAL_BASE}" ]]; then
    if [[ -n "${ORACLE_BASE}" ]] && [[ -d "${ORACLE_BASE}/local" ]]; then
        # Use ORACLE_BASE/local if available (typical Oracle installation)
        export ORADBA_LOCAL_BASE="${ORACLE_BASE}/local"
    else
        # Derive from ORADBA_PREFIX parent directory
        # shellcheck disable=SC2155  # Acceptable in config files
        export ORADBA_LOCAL_BASE="$(dirname "${ORADBA_PREFIX}")"
    fi
else
    export ORADBA_LOCAL_BASE
fi

# Base directory (alias for compatibility with TVD BasEnv when installed in parallel)
# Note: ORADBA_BASE and ORADBA_PREFIX always point to the same location
export ORADBA_BASE="${ORADBA_PREFIX}"

# Subdirectories
export ORADBA_BIN_DIR="${ORADBA_BIN_DIR:-${ORADBA_PREFIX}/bin}"
export ORADBA_BIN="${ORADBA_BIN_DIR}"  # Alias for compatibility
export ORADBA_CONFIG_DIR="${ORADBA_CONFIG_DIR:-${ORADBA_PREFIX}/etc}"
export ORADBA_ETC="${ORADBA_CONFIG_DIR}"  # Alias for compatibility
export ORADBA_LOG="${ORADBA_LOG:-${ORADBA_PREFIX}/log}"
export ORADBA_TEMP="${ORADBA_TEMP:-${ORADBA_PREFIX}/tmp}"

# Default oratab location
export ORATAB_FILE="${ORATAB_FILE:-/etc/oratab}"

# Alternative oratab locations to check
ORATAB_ALTERNATIVES=(
    "/etc/oratab"
    "/var/opt/oracle/oratab"
    "${HOME}/.oratab"
)

# ------------------------------------------------------------------------------
# Core Behavior Settings
# ------------------------------------------------------------------------------

# Debug mode (0=off, 1=on)
export DEBUG="${DEBUG:-0}"

# Load aliases and functions (true/false)
export ORADBA_LOAD_ALIASES="${ORADBA_LOAD_ALIASES:-true}"

# Load database status on environment switch (true/false)
export ORADBA_SHOW_DB_STATUS="${ORADBA_SHOW_DB_STATUS:-true}"

# Auto-create SID configuration files (true/false)
export ORADBA_AUTO_CREATE_SID_CONFIG="${ORADBA_AUTO_CREATE_SID_CONFIG:-true}"

# Customize PS1 prompt with ORACLE_SID (true/false)
export ORADBA_CUSTOMIZE_PS1="${ORADBA_CUSTOMIZE_PS1:-true}"

# rlwrap password filter (true/false)
# When enabled, passwords are hidden from command history in SQL*Plus and RMAN
# Requires: perl with RlwrapFilter module
export ORADBA_RLWRAP_FILTER="${ORADBA_RLWRAP_FILTER:-false}"

# PDB aliases (true/false)
# When false (ORADBA_NO_PDB_ALIASES=true), disables automatic PDB alias generation
# PDB aliases allow quick connection to pluggable databases in CDB environments
export ORADBA_NO_PDB_ALIASES="${ORADBA_NO_PDB_ALIASES:-false}"

# RMAN catalog connection
# When set, rmanc and rmanch aliases will connect to the specified catalog
# Format: user/password@tnsalias or user@tnsalias (will prompt for password)
# Can be overridden per SID in sid.<SID>.conf
export ORADBA_RMAN_CATALOG="${ORADBA_RMAN_CATALOG:-}"

# ------------------------------------------------------------------------------
# SQLPATH Configuration (#11)
# ------------------------------------------------------------------------------

# Enable SQLPATH configuration (default: true)
# When enabled, SQLPATH is automatically configured when sourcing oraenv.sh
export ORADBA_CONFIGURE_SQLPATH="${ORADBA_CONFIGURE_SQLPATH:-true}"

# Preserve existing SQLPATH entries when sourcing new environment (default: false)
# When true, existing SQLPATH directories are preserved and appended
export ORADBA_PRESERVE_SQLPATH="${ORADBA_PRESERVE_SQLPATH:-false}"

# Custom SQLPATH directories (colon-separated)
# These will be appended to the standard SQLPATH
# Example: ORADBA_CUSTOM_SQLPATH="/opt/scripts/sql:/shared/oracle/sql"
export ORADBA_CUSTOM_SQLPATH="${ORADBA_CUSTOM_SQLPATH:-}"

# Create user SQL directory automatically (default: true)
# When true, creates ~/.oradba/sql if it doesn't exist
export ORADBA_CREATE_USER_SQL_DIR="${ORADBA_CREATE_USER_SQL_DIR:-true}"

# SID-specific SQL directories (default: true)
# When true, creates/includes ${ORADBA_PREFIX}/sql/${ORACLE_SID} in SQLPATH
export ORADBA_SID_SPECIFIC_SQL="${ORADBA_SID_SPECIFIC_SQL:-true}"

# ------------------------------------------------------------------------------
# Logging Configuration
# ------------------------------------------------------------------------------

# Log directory
export LOG_DIR="${LOG_DIR:-${ORADBA_PREFIX}/logs}"

# Log level (DEBUG, INFO, WARN, ERROR)
export LOG_LEVEL="${LOG_LEVEL:-INFO}"

# ------------------------------------------------------------------------------
# Directory Paths
# ------------------------------------------------------------------------------

# Backup and recovery directories
export BACKUP_DIR="${BACKUP_DIR:-/backup}"
export RECOVERY_DIR="${RECOVERY_DIR:-${ORADBA_PREFIX}/rcv}"

# ------------------------------------------------------------------------------
# System Commands
# ------------------------------------------------------------------------------

# ps command with wide output
export ORADBA_PS="${ORADBA_PS:-ps -ef}"  # Use 'ps -ef -www' for extra wide output

# ------------------------------------------------------------------------------
# PATH Configuration
# ------------------------------------------------------------------------------

# Add OraDBA bin directory to PATH if not already present
if [[ -d "${ORADBA_BIN_DIR}" ]]; then
    case ":${PATH}:" in
        *":${ORADBA_BIN_DIR}:"*)
            # Already in PATH, do nothing
            ;;
        *)
            # Add to beginning of PATH
            export PATH="${ORADBA_BIN_DIR}:${PATH}"
            ;;
    esac
fi
