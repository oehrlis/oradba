#!/usr/bin/env bash
# ------------------------------------------------------------------------------
# OraDBA - Oracle Database Administration Toolset (https://www.oradba.ch)
# ------------------------------------------------------------------------------
# Name.......: oradba_standard.conf
# Author.....: Stefan Oehrli (oes) stefan.oehrli@oradba.ch
# Editor.....: Stefan Oehrli
# Date.......: 2025.12.16
# Revision...: 0.5.0
# Purpose....: Standard environment variables and simple aliases for OraDBA
# Notes......: Loaded after oradba_core.conf. Override in oradba_customer.conf
# ------------------------------------------------------------------------------

# ------------------------------------------------------------------------------
# Standard Oracle Environment Variables
# ------------------------------------------------------------------------------

# Default Oracle base directory
export ORACLE_BASE="${ORACLE_BASE:-/u01/app/oracle}"

# Default TNS_ADMIN (will be set to ORACLE_HOME/network/admin if not specified)
export TNS_ADMIN="${TNS_ADMIN:-}"

# NLS settings
export NLS_LANG="${NLS_LANG:-AMERICAN_AMERICA.AL32UTF8}"
export NLS_DATE_FORMAT="${NLS_DATE_FORMAT:-YYYY-MM-DD HH24:MI:SS}"
export NLS_TIMESTAMP_FORMAT="${NLS_TIMESTAMP_FORMAT:-YYYY-MM-DD HH24:MI:SS.FF}"

# SQL*Plus settings
export SQLPATH="${SQLPATH:-${ORADBA_PREFIX}/sql}"
export ORACLE_PATH="${ORACLE_PATH:-${ORADBA_PREFIX}/sql}"

# PATH customization
# Note: PATH modifications in config files are automatically exported due to set -a
# You can customize PATH in oradba_customer.conf or sid.*.conf:
#   PATH="${ORADBA_PREFIX}/bin:${PATH}"
# Issue #24 will add automatic PATH setup via .bash_profile during installation

# rlwrap (readline wrapper for SQL*Plus, RMAN)
export RLWRAP_COMMAND="${RLWRAP_COMMAND:-rlwrap}"
export RLWRAP_OPTS="${RLWRAP_OPTS:--i -c -f $ORACLE_HOME/bin/sqlplus}"

# rlwrap filter for password hiding (requires Perl RlwrapFilter module)
# Set to "true" to enable password filtering in command history
export ORADBA_RLWRAP_FILTER="${ORADBA_RLWRAP_FILTER:-false}"
export ORADBA_RLWRAP_FILTER_PATH="${ORADBA_RLWRAP_FILTER_PATH:-${ORADBA_ETC}/rlwrap_filter_oracle}"

# TWO_TASK for remote connections
export ORADBA_TWO_TASK="${ORADBA_TWO_TASK:-}"

# Admin and diagnostic directories (always calculated dynamically based on current environment)
# These are set AFTER SID configs load so we have ORADBA_DIAGNOSTIC_DEST if defined
# Note: These will be set properly at end of this file after SID config loads

# ------------------------------------------------------------------------------
# SID Lists and Aliases (from oratab)
# ------------------------------------------------------------------------------

# Generate SID lists and aliases from oratab
# This creates:
# - ORADBA_SIDLIST: All SIDs from oratab (Y, N, D)
# - ORADBA_REALSIDLIST: Only real SIDs (Y, N - excludes D for DGMGRL dummy)
# - Aliases for each SID (e.g., alias free='. oraenv.sh FREE')
if [[ -f "${ORADBA_PREFIX}/lib/common.sh" ]]; then
    generate_sid_lists "${ORATAB:-/etc/oratab}"
fi

# ------------------------------------------------------------------------------
# PDB Aliases (for Multitenant CDB)
# ------------------------------------------------------------------------------

# Generate PDB aliases for current CDB
# This creates:
# - ORADBA_PDBLIST: List of PDBs in current CDB
# - Aliases for each PDB (e.g., alias pdb1='export ORADBA_PDB=PDB1; sqlplus...')
# - Prefixed aliases (e.g., alias pdbpdb1='...')
# Skipped if ORADBA_NO_PDB_ALIASES=true or not connected to a CDB
if [[ -f "${ORADBA_PREFIX}/lib/common.sh" ]] && [[ -n "${ORACLE_SID}" ]]; then
    generate_pdb_aliases
fi

# ------------------------------------------------------------------------------
# RMAN Catalog Connection
# ------------------------------------------------------------------------------

# Load RMAN catalog connection string if configured
# This sets ORADBA_RMAN_CATALOG_CONNECTION for use in rmanc/rmanch aliases
if [[ -f "${ORADBA_PREFIX}/lib/common.sh" ]]; then
    load_rman_catalog_connection
fi

# Directory aliases for short variables
alias etc='cd ${ORADBA_ETC}'
alias log='cd ${ORADBA_LOG}'
alias cdl='cd ${ORACLE_BASE}/local'

# ------------------------------------------------------------------------------
# Simple Aliases (Oracle Tools)
# ------------------------------------------------------------------------------

# SQL*Plus aliases (with optional rlwrap and password filter support)
alias sq='sqlplus / as sysdba'
alias sessionsql='${ORADBA_PREFIX}/bin/sessionsql.sh'
if [[ "${ORADBA_RLWRAP_FILTER}" == "true" ]] && [[ -x "${ORADBA_RLWRAP_FILTER_PATH}" ]]; then
    alias sqh='command -v rlwrap &>/dev/null && rlwrap -f "${ORADBA_ETC}/rlwrap_sqlplus_completions" -z "${ORADBA_RLWRAP_FILTER_PATH}" sqlplus / as sysdba || sqlplus / as sysdba'
    alias sqlplush='command -v rlwrap &>/dev/null && rlwrap -f "${ORADBA_ETC}/rlwrap_sqlplus_completions" -z "${ORADBA_RLWRAP_FILTER_PATH}" sqlplus /nolog || sqlplus /nolog'
    alias sqoh='command -v rlwrap &>/dev/null && rlwrap -f "${ORADBA_ETC}/rlwrap_sqlplus_completions" -z "${ORADBA_RLWRAP_FILTER_PATH}" sqlplus / as sysoper || sqlplus / as sysoper'
else
    alias sqh='command -v rlwrap &>/dev/null && rlwrap -f "${ORADBA_ETC}/rlwrap_sqlplus_completions" sqlplus / as sysdba || sqlplus / as sysdba'
    alias sqlplush='command -v rlwrap &>/dev/null && rlwrap -f "${ORADBA_ETC}/rlwrap_sqlplus_completions" sqlplus /nolog || sqlplus /nolog'
    alias sqoh='command -v rlwrap &>/dev/null && rlwrap -f "${ORADBA_ETC}/rlwrap_sqlplus_completions" sqlplus / as sysoper || sqlplus / as sysoper'
fi

# RMAN aliases (with optional rlwrap and password filter support)
alias rman='rman target /'

# RMAN with catalog - uses ORADBA_RMAN_CATALOG_CONNECTION if set, else prompts for catalog
if [[ -n "${ORADBA_RMAN_CATALOG_CONNECTION}" ]]; then
    alias rmanc="rman target / ${ORADBA_RMAN_CATALOG_CONNECTION}"
else
    alias rmanc='rman target / catalog'
fi

# RMAN with rlwrap (history support)
if [[ "${ORADBA_RLWRAP_FILTER}" == "true" ]] && [[ -x "${ORADBA_RLWRAP_FILTER_PATH}" ]]; then
    alias rmanh='command -v ${RLWRAP_COMMAND} &>/dev/null && ${RLWRAP_COMMAND} -f "${ORADBA_ETC}/rlwrap_rman_completions" -z "${ORADBA_RLWRAP_FILTER_PATH}" rman target / || rman target /'
    if [[ -n "${ORADBA_RMAN_CATALOG_CONNECTION}" ]]; then
        alias rmanch="command -v \${RLWRAP_COMMAND} &>/dev/null && \${RLWRAP_COMMAND} -f \"\${ORADBA_ETC}/rlwrap_rman_completions\" -z \"\${ORADBA_RLWRAP_FILTER_PATH}\" rman target / ${ORADBA_RMAN_CATALOG_CONNECTION} || rman target / ${ORADBA_RMAN_CATALOG_CONNECTION}"
    else
        alias rmanch='command -v ${RLWRAP_COMMAND} &>/dev/null && ${RLWRAP_COMMAND} -f "${ORADBA_ETC}/rlwrap_rman_completions" -z "${ORADBA_RLWRAP_FILTER_PATH}" rman target / catalog || rman target / catalog'
    fi
else
    alias rmanh='command -v ${RLWRAP_COMMAND} &>/dev/null && ${RLWRAP_COMMAND} -f "${ORADBA_ETC}/rlwrap_rman_completions" rman target / || rman target /'
    if [[ -n "${ORADBA_RMAN_CATALOG_CONNECTION}" ]]; then
        alias rmanch="command -v \${RLWRAP_COMMAND} &>/dev/null && \${RLWRAP_COMMAND} -f \"\${ORADBA_ETC}/rlwrap_rman_completions\" rman target / ${ORADBA_RMAN_CATALOG_CONNECTION} || rman target / ${ORADBA_RMAN_CATALOG_CONNECTION}"
    else
        alias rmanch='command -v ${RLWRAP_COMMAND} &>/dev/null && ${RLWRAP_COMMAND} -f "${ORADBA_ETC}/rlwrap_rman_completions" rman target / catalog || rman target / catalog'
    fi
fi

# Listener alias
alias lsnr='lsnrctl'
alias lsnrh='command -v ${RLWRAP_COMMAND} &>/dev/null && ${RLWRAP_COMMAND} -f "${ORADBA_ETC}/rlwrap_lsnrctl_completions" lsnrctl || lsnrctl'

# ADRCI (Automatic Diagnostic Repository Command Interpreter) with rlwrap
if [[ "${ORADBA_RLWRAP_FILTER}" == "true" ]] && [[ -x "${ORADBA_RLWRAP_FILTER_PATH}" ]]; then
    alias adrcih='command -v ${RLWRAP_COMMAND} &>/dev/null && ${RLWRAP_COMMAND} -f "${ORADBA_ETC}/rlwrap_adrci_completions" -z "${ORADBA_RLWRAP_FILTER_PATH}" adrci || adrci'
else
    alias adrcih='command -v ${RLWRAP_COMMAND} &>/dev/null && ${RLWRAP_COMMAND} -f "${ORADBA_ETC}/rlwrap_adrci_completions" adrci || adrci'
fi

# ------------------------------------------------------------------------------
# Simple Aliases (Utilities)
# ------------------------------------------------------------------------------

# Basic shell utilities
alias c='clear'
alias m='more'
alias l='ls -al'
alias ll='ls -alb'
alias lr='ls -ltr'
alias lsl='ls -lrt | tail -n 20'

# Grep utilities
alias psg='${ORADBA_PS} | grep -v " grep " | grep'
alias alig='alias | grep -i'

# Oracle status overview
alias oraup='${ORADBA_PREFIX}/bin/oraup.sh'
alias u='${ORADBA_PREFIX}/bin/oraup.sh'

# SQLPATH management (#11)
alias sqa='show_sqlpath'

# ------------------------------------------------------------------------------
# Simple Aliases (Directory Navigation)
# ------------------------------------------------------------------------------

# OraDBA directories
alias cdob='cd ${ORACLE_BASE}'
alias cdh='cd ${ORACLE_HOME}'
alias cdbn='cd ${ORACLE_HOME}/bin'
alias cdn='cd ${TNS_ADMIN:-${ORACLE_HOME}/network/admin}/..'

# ------------------------------------------------------------------------------
# Simple Aliases (Database Operations)
# ------------------------------------------------------------------------------

# Listener and database status
alias lstat='lsnrctl status'
alias lstart='lsnrctl start'
alias lstop='lsnrctl stop'
alias pmon='ps -ef | grep pmon'

# Configuration files
alias oratab='cat ${ORATAB_FILE:-/etc/oratab}'
alias tns='cat ${TNS_ADMIN:-${ORACLE_HOME}/network/admin}/tnsnames.ora'

# ------------------------------------------------------------------------------
# Simple Aliases (Editor Shortcuts)
# ------------------------------------------------------------------------------

# Edit common Oracle files
alias vio='vi ${ORATAB_FILE}'
alias vit='vi ${TNS_ADMIN}/tnsnames.ora'
alias vil='vi ${TNS_ADMIN}/listener.ora'
alias visql='vi ${TNS_ADMIN}/sqlnet.ora'
alias vildap='vi ${TNS_ADMIN}/ldap.ora'

# Edit OraDBA configuration files
alias vis='vi ${ORADBA_CONFIG_DIR}/sid.${ORACLE_SID}.conf'
alias vic='vi ${ORADBA_CONFIG_DIR}/oradba_customer.conf'

# ------------------------------------------------------------------------------
# Simple Aliases (Additional Directory Navigation)
# ------------------------------------------------------------------------------

# OraDBA subdirectories
alias cdb='cd ${ORADBA_PREFIX}'
alias cde='cd $(dirname ${ORATAB_FILE})'
alias cdr='cd ${ORACLE_HOME}/rdbms/admin'
alias cdt='cd ${TNS_ADMIN}'
alias cdn='cd ${TNS_ADMIN}/..'

# Log and temp directories
alias cdlog='cd ${ORADBA_LOG}'
alias cdtmp='cd ${ORADBA_TEMP}'

# ------------------------------------------------------------------------------
# Simple Aliases (Miscellaneous)
# ------------------------------------------------------------------------------

# Database status
alias sta='${ORADBA_PREFIX}/bin/dbstatus.sh'

# OraDBA version and help
alias version='${ORADBA_PREFIX}/bin/oradba_version.sh -i'
alias alih='cat ${ORADBA_PREFIX}/doc/ALIAS_HELP.txt 2>/dev/null || echo "Alias help file not found. See ${ORADBA_PREFIX}/doc/ALIASES.md"'

# Save crontab
alias save_cron='crontab -l > $HOME/crontab.txt.$(date +%Y-%m-%d_%H:%M:%S)'

# ------------------------------------------------------------------------------
# Dynamic Aliases (Set by SID configuration)
# ------------------------------------------------------------------------------

# These aliases use variables set in SID-specific configs

if [[ -n "${ORADBA_ORA_ADMIN_SID}" ]]; then
    alias cda='cd ${ORADBA_ORA_ADMIN_SID}'
    alias cdc='cd ${ORADBA_ORA_ADMIN_SID}/create'
    alias vii='vi ${ORADBA_ORA_ADMIN_SID}/pfile/init${ORACLE_SID}.ora'
fi

# Alert log aliases (fallback - will be overridden by aliases.sh if diagnostic dirs exist)
# These work with standard ORACLE_BASE/ORACLE_SID layout
if [[ -n "${ORACLE_SID}" ]] && [[ -n "${ORACLE_BASE}" ]]; then
    # Alert log aliases using ORADBA_SID_ALERTLOG variable
    alias taa='if [ -f "${ORADBA_SID_ALERTLOG}" ]; then tail -f -n 50 ${ORADBA_SID_ALERTLOG}; else echo "ORADBA_SID_ALERTLOG not defined or file not found"; fi'
    alias vaa='if [ -f "${ORADBA_SID_ALERTLOG}" ]; then less ${ORADBA_SID_ALERTLOG}; else echo "ORADBA_SID_ALERTLOG not defined or file not found"; fi'
    alias via='if [ -f "${ORADBA_SID_ALERTLOG}" ]; then vi ${ORADBA_SID_ALERTLOG}; else echo "ORADBA_SID_ALERTLOG not defined or file not found"; fi'
    # shellcheck disable=SC2139  # Intentional: expand at definition for current SID
    alias cdd='cd ${ORACLE_BASE}/diag/rdbms/${ORACLE_SID,,}/${ORACLE_SID}'
    # shellcheck disable=SC2139  # Intentional: expand at definition for current SID
    alias cddt='cd ${ORACLE_BASE}/diag/rdbms/${ORACLE_SID,,}/${ORACLE_SID}/trace'
    # shellcheck disable=SC2139  # Intentional: expand at definition for current SID
    alias cdda='cd ${ORACLE_BASE}/diag/rdbms/${ORACLE_SID,,}/${ORACLE_SID}/alert'
fi

# Note: Above aliases may be overridden by generate_sid_aliases() in aliases.sh
# which queries the database for diagnostic_dest

# ------------------------------------------------------------------------------
# Load Dynamic Aliases and Functions
# ------------------------------------------------------------------------------

# Source aliases.sh for dynamic alias generation if aliases are enabled
if [[ "${ORADBA_LOAD_ALIASES}" == "true" ]]; then
    if [[ -f "${ORADBA_PREFIX}/lib/aliases.sh" ]]; then
        # shellcheck source=/dev/null
        source "${ORADBA_PREFIX}/lib/aliases.sh"
    fi
fi

# ------------------------------------------------------------------------------
# Admin and Diagnostic Directories (calculated dynamically after SID config loads)
# ------------------------------------------------------------------------------

# Set these based on current ORACLE_BASE and ORACLE_SID (not from config file)
export ORADBA_ORA_ADMIN_SID="${ORACLE_BASE}/admin/${ORACLE_SID}"

# Use ORADBA_DIAGNOSTIC_DEST if set in SID config, otherwise calculate default
if [[ -n "${ORADBA_DIAGNOSTIC_DEST}" ]]; then
    export ORADBA_ORA_DIAG_SID="${ORADBA_DIAGNOSTIC_DEST}"
else
    export ORADBA_ORA_DIAG_SID="${ORACLE_BASE}/diag/rdbms/${ORACLE_SID,,}/${ORACLE_SID}"
fi

# Control file directory (if set in SID config)
export ORADBA_ORA_CONTROL="${ORADBA_ORA_CONTROL:-${ORACLE_BASE}/oradata/${ORACLE_SID}}"

# Alert log file path (standard text format, not XML)
if [[ -n "${ORACLE_SID}" ]] && [[ -n "${ORACLE_BASE}" ]]; then
    export ORADBA_SID_ALERTLOG="${ORADBA_ORA_DIAG_SID}/trace/alert_${ORACLE_SID}.log"
fi

# ------------------------------------------------------------------------------
# Short Directory Variables (set after SID config to get correct values)
# ------------------------------------------------------------------------------

export cdh="${ORACLE_HOME}"
export cda="${ORADBA_ORA_ADMIN_SID}"
export cdob="${ORACLE_BASE}"
export cdl="${ORACLE_BASE}/local"
export cdd="${ORADBA_ORA_DIAG_SID}"
export etc="${ORADBA_ETC}"
export log="${ORADBA_LOG}"
export cdn="${TNS_ADMIN}/.."

# Aliases for short variables that depend on SID config
alias cda='cd "${ORADBA_ORA_ADMIN_SID}"'
alias cdd='cd "${ORADBA_ORA_DIAG_SID}"'

# ------------------------------------------------------------------------------
# Prompt Customization (PS1/PS1BASH with ORACLE_SID)
# ------------------------------------------------------------------------------

# Customize bash prompt to include ORACLE_SID if enabled
if [[ "${ORADBA_CUSTOMIZE_PS1}" == "true" ]] && [[ -n "${ORACLE_SID}" ]]; then
    # PS1BASH: Use bash escape sequences (\u, \h, \w)
    # Shows: user@host:path/ [ORACLE_SID] or [ORACLE_SID.PDB] if ORADBA_PDB is set
    export PS1BASH='\u@\h:\w/ [${ORACLE_SID}${ORADBA_PDB:+.$ORADBA_PDB}] '
    
    # PS1: Use environment variables (for non-bash shells or explicit variable expansion)
    # Shows: user@host:path/ [ORACLE_SID] or [ORACLE_SID.PDB] if ORADBA_PDB is set
    export PS1='${LOGNAME}@${HOSTNAME}:${PWD}/ [${ORACLE_SID}${ORADBA_PDB:+.$ORADBA_PDB}] '
    
    # Use PS1BASH as the actual prompt (works in bash/zsh/ksh)
    # Set PROMPT_COMMAND to expand PS1BASH dynamically
    if [[ -n "$BASH_VERSION" ]]; then
        # For bash, we can use PS1BASH directly
        PS1="$PS1BASH"
    fi
fi
